# RAGE System Architecture

**Version**: 2.0  
**Last Updated**: December 3, 2025  
**Status**: Design Phase (Layer 10 Added)

---

## Table of Contents

1. [Overview](#overview)config:
  flowchart:
    defaultRenderer: "elk"
2. [System Design Principles](#system-design-principles)
3. [Architecture Layers](#architecture-layers)
4. [Component Interactions](#component-interactions)
5. [Data Flow](#data-flow)
6. [Scalability & Performance](#scalability--performance)
7. [Security Architecture](#security-architecture)
8. [Monitoring Architecture](#monitoring-architecture)

---

## 1. Overview

### 1.1 Architecture Philosophy

RAGE follows a **microservices-inspired monolith** architecture with clear separation of concerns:

- **Modular Components**: Each subsystem is independently deployable
- **Message-Driven**: Agents communicate via MCP (Model Context Protocol)
- **Event-Driven**: Real-time updates via WebSocket and pub/sub
- **Database-per-Concern**: PostgreSQL (metadata), Neo4j (graph), Valkey (cache)
- **Container-First**: Every component runs in isolated containers with Netdata monitoring

### 1.2 Key Architectural Decisions

| Decision | Rationale |
|----------|-----------|
| **Podman Primary, Docker Fallback** | Rootless containers, better security, daemonless architecture |
| **Mantine UI Primary** | Rich component library, TypeScript support, accessibility |
| **Multi-LLM Support** | Avoid vendor lock-in, cost optimization, fallback resilience |
| **Neo4j for Knowledge Graph** | Native graph operations, Cypher query language, vector support |
| **Valkey over Redis** | Drop-in replacement, open-source commitment |
| **Netdata per Container** | Real-time metrics, low overhead, beautiful UI |
| **MCP Protocol** | Standardized agent communication, extensibility |
| **libp2p for P2P** | Production-ready, NAT traversal, used by IPFS/Filecoin/Ethereum 2.0 |
| **Hybrid CDN** | Multi-provider (Cloudflare/Fastly/AWS) + self-hosted for flexibility |
| **Explicit Trust Lists** | Maximum security for federated instances, zero-trust by default |
| **CRDTs for Sync** | Conflict-free replication, eventual consistency across distributed nodes |

---

## 2. System Design Principles

### 2.1 SOLID Principles Applied

1. **Single Responsibility**: Each agent has one well-defined purpose
2. **Open/Closed**: New LLM providers can be added without modifying existing code
3. **Liskov Substitution**: All agents implement the same `NeuralAgent` interface
4. **Interface Segregation**: Agents only depend on protocols they use
5. **Dependency Inversion**: Components depend on abstractions (protocols), not implementations

### 2.2 Design Patterns

- **Strategy Pattern**: LLM provider selection
- **Observer Pattern**: Agent activity monitoring
- **Factory Pattern**: Agent instantiation
- **Repository Pattern**: Data access abstraction
- **Command Pattern**: Task assignments in MCP
- **Chain of Responsibility**: Document processing pipeline

---

## 3. Architecture Layers

### 3.1 Layer Diagram

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TB
    %% Title: Complete Architecture Layers
    subgraph Presentation["Presentation Layer"]
        Frontend["Frontend (React + Mantine UI + TypeScript)"]
        FrontendItems["‚Ä¢ Chat Interface<br/>‚Ä¢ Document Management<br/>‚Ä¢ Graph Visualization (Three.js + D3)<br/>‚Ä¢ Admin Dashboard<br/>‚Ä¢ User Settings"]
        Frontend --> FrontendItems
    end

    subgraph Gateway["Gateway Layer"]
        GW["Nginx / Traefik"]
        GWItems["‚Ä¢ SSL/TLS Termination<br/>‚Ä¢ Load Balancing<br/>‚Ä¢ Rate Limiting<br/>‚Ä¢ Request Routing<br/>‚Ä¢ DDoS Protection"]
        GW --> GWItems
    end

    subgraph Application["Application Layer"]
        FastAPI["FastAPI Application"]
        CoreAPI["Core API<br/>‚Ä¢ Auth<br/>‚Ä¢ Users<br/>‚Ä¢ Teams<br/>‚Ä¢ Health"]
        QueryAPI["Query API<br/>‚Ä¢ Search<br/>‚Ä¢ Chat<br/>‚Ä¢ RAG<br/>‚Ä¢ Citations"]
        AdminAPI["Admin API<br/>‚Ä¢ Config<br/>‚Ä¢ Ingestion<br/>‚Ä¢ Analytics<br/>‚Ä¢ Monitoring"]
        Middleware["Middleware:<br/>‚Ä¢ JWT Authentication<br/>‚Ä¢ CORS Headers<br/>‚Ä¢ Request Logging<br/>‚Ä¢ Error Handling<br/>‚Ä¢ Rate Limiting"]
        FastAPI --> CoreAPI
        FastAPI --> QueryAPI
        FastAPI --> AdminAPI
        FastAPI --> Middleware
    end

    subgraph Orchestration["Orchestration Layer"]
        Orch["Query Orchestrator (MCP Coordinator)"]
        OrchItems["‚Ä¢ Agent Registry & Discovery<br/>‚Ä¢ Task Assignment & Scheduling<br/>‚Ä¢ Progress Tracking<br/>‚Ä¢ Result Aggregation<br/>‚Ä¢ Error Recovery & Retry<br/>‚Ä¢ Resource Management"]
        Orch --> OrchItems
        
        CM["Concept Mapper<br/>‚Ä¢ NER<br/>‚Ä¢ Concept Mapping<br/>‚Ä¢ Relations"]
        DR["Document Retriever<br/>‚Ä¢ Vector<br/>‚Ä¢ Keyword<br/>‚Ä¢ Graph<br/>‚Ä¢ Hybrid"]
        AS["Answer Synthesizer<br/>‚Ä¢ LLM Gen<br/>‚Ä¢ Citations<br/>‚Ä¢ Scoring<br/>‚Ä¢ Validate"]
        QA["Query Analyzer<br/>‚Ä¢ Intent<br/>‚Ä¢ Expansion<br/>‚Ä¢ Language Detect"]
        
        Orch -.-> CM
        Orch -.-> DR
        Orch -.-> AS
        Orch -.-> QA
    end

    subgraph Business["Business Logic Layer"]
        Search["Search Engine"]
        VS["Vector Search<br/>(Semantic)"]
        KS["Keyword Search<br/>(BM25)"]
        GT["Graph Traversal<br/>(Concepts)"]
        HF["Hybrid Fusion<br/>(RRF)"]
        Search --> VS
        Search --> KS
        Search --> GT
        VS --> HF
        KS --> HF
        GT --> HF
    end

    Presentation -->|HTTPS/WSS| Gateway
    Gateway -->|HTTP/WS| Application
    Application -->|MCP Protocol| Orchestration
    Orchestration --> Business
    
    classDef layer fill:#0d47a1,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px;
    class Presentation,Gateway,Application,Orchestration,Business layer;
    
    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

---

## 4. Component Interactions

### 4.1 Query Processing Flow (Mermaid Sequence Diagram)

```mermaid
%%{init: {'theme':'dark', 'themeVariables': {'actorTextColor':'#fff', 'noteBkgColor':'#1a237e', 'noteTextColor':'#fff'}}}%%
sequenceDiagram
    title Query Processing Flow
    actor User
    participant UI as Frontend UI<br/>(Mantine)
    participant Gateway as API Gateway<br/>(Nginx)
    participant API as FastAPI<br/>Query Router
    participant Cache as Valkey<br/>(Cache)
    participant Orch as Query<br/>Orchestrator
    participant CM as Concept<br/>Mapper
    participant DR as Document<br/>Retriever
    participant AS as Answer<br/>Synthesizer
    participant QA as Query<br/>Analyzer
    participant Neo4j as Neo4j<br/>(Graph DB)
    participant PG as PostgreSQL<br/>(Metadata)
    participant LLM as LLM Router<br/>(Ollama/OpenAI)

    User->>UI: 1. Submit Query
    UI->>Gateway: 2. POST /api/v1/query
    Gateway->>API: 3. Route + Auth
    API->>Cache: 4. Check Cache
    alt Cache Hit
        Cache-->>API: Return Cached Answer
        API-->>UI: 9. JSON Response
        UI-->>User: Display Answer
    else Cache Miss
        API->>Orch: 5. Distribute Tasks (MCP)
        
        par Parallel Agent Execution
            Orch->>CM: 6a. Extract Concepts
            CM->>Neo4j: Query Concepts
            Neo4j-->>CM: Concept Nodes
            
            Orch->>DR: 6b. Search Documents
            DR->>Neo4j: Vector + Graph Search
            DR->>PG: Metadata Query
            Neo4j-->>DR: Results
            PG-->>DR: Results
            
            Orch->>AS: 6c. Generate Answer
            AS->>LLM: Generate with Context
            LLM-->>AS: Answer + Citations
            
            Orch->>QA: 6d. Analyze Intent
            QA-->>Orch: Intent Analysis
        end
        
        CM-->>Orch: 7. Concept Results
        DR-->>Orch: 7. Document Results
        AS-->>Orch: 7. Generated Answer
        
        Orch->>Orch: 8. Aggregate Results
        Orch->>Cache: Cache Result
        Orch-->>API: Combined Result
        API-->>UI: 9. JSON Response
        UI-->>User: Display Answer
    end
```

### 4.2 Query Processing Flow (3D Architecture View)

```mermaid
%%{init: {'theme': 'base'}}%%
graph TB
    %% Title: 3D Architecture Layers
    subgraph Layer_1["Layer 1: Presentation"]
        class Layer_1 sameWidth;
        User[üë§ User]
        UI[üñ•Ô∏è Frontend UI<br/>React + Mantine]
    end

    subgraph Layer_2["Layer 2: Gateway"]
        class Layer_2 sameWidth;
        Gateway[üö™ API Gateway<br/>Nginx/Traefik<br/>SSL + Load Balancer]
    end

    subgraph Layer_3["Layer 3: Application"]
        class Layer_3 sameWidth;
        API[‚ö° FastAPI<br/>Query Router<br/>Auth + Validation]
        Cache{üíæ Valkey Cache<br/>Exact + Semantic}
    end

    subgraph Layer_4["Layer 4: Orchestration"]
        class Layer_4 sameWidth;
        Orch[üéØ Query Orchestrator<br/>MCP Coordinator]
    end

    subgraph Layer_5["Layer 5: Agent Network"]
        class Layer_5 sameWidth;
        direction LR
        CM[üß† Concept<br/>Mapper<br/>NER + Relations]
        DR[üìö Document<br/>Retriever<br/>Hybrid Search]
        AS[‚úçÔ∏è Answer<br/>Synthesizer<br/>LLM Generation]
        QA[üîç Query<br/>Analyzer<br/>Intent Detection]
    end

    subgraph Layer_6["Layer 6: Data Storage"]
        class Layer_6 sameWidth;
        direction LR
        Neo4j[(üï∏Ô∏è Neo4j<br/>Knowledge Graph<br/>Vectors + Relations)]
        PG[(üóÑÔ∏è PostgreSQL<br/>Structured Data<br/>Metadata)]
    end

    subgraph Layer_7["Layer 7: LLM Providers"]
        class Layer_7 sameWidth;
        direction LR
        Ollama[ü¶ô Ollama<br/>Local Models]
        OpenAI[ü§ñ OpenAI<br/>GPT-4]
        Claude[üé≠ Anthropic<br/>Claude]
        Custom[‚öôÔ∏è Custom<br/>Endpoints]
    end

    User -->|Submit Query| UI
    UI -->|HTTPS| Gateway
    Gateway -->|Route| API
    API -->|Check| Cache
    Cache -.->|Hit| API
    Cache -->|Miss| Orch

    Orch -->|MCP Tasks| CM
    Orch -->|MCP Tasks| DR
    Orch -->|MCP Tasks| AS
    Orch -->|MCP Tasks| QA

    CM <-->|Cypher| Neo4j
    DR <-->|Cypher + SQL| Neo4j
    DR <-->|SQL| PG
    AS -->|Generate| Ollama
    AS -->|Generate| OpenAI
    AS -->|Generate| Claude
    AS -->|Generate| Custom

    CM -->|Results| Orch
    DR -->|Results| Orch
    AS -->|Results| Orch
    QA -->|Results| Orch

    Orch -->|Aggregate| API
    API -->|Cache| Cache
    API -->|Response| UI
    UI -->|Display| User

    style User fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:3px
    style UI fill:#1565c0,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px
    style Gateway fill:#0277bd,fill-opacity:0.18,stroke:#4fc3f7,stroke-width:2px
    style API fill:#01579b,fill-opacity:0.18,stroke:#4dd0e1,stroke-width:2px
    style Cache fill:#006064,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px
    style Orch fill:#004d40,fill-opacity:0.18,stroke:#26a69a,stroke-width:3px
    style CM fill:#1b5e20,fill-opacity:0.18,stroke:#66bb6a,stroke-width:2px
    style DR fill:#33691e,fill-opacity:0.18,stroke:#9ccc65,stroke-width:2px
    style AS fill:#827717,fill-opacity:0.18,stroke:#dce775,stroke-width:2px
    style QA fill:#f57f17,fill-opacity:0.18,stroke:#ffb74d,stroke-width:2px
    style Neo4j fill:#4a148c,fill-opacity:0.18,stroke:#ba68c8,stroke-width:2px
    style PG fill:#6a1b9a,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px
    style Ollama fill:#bf360c,fill-opacity:0.18,stroke:#ff8a65,stroke-width:2px
    style OpenAI fill:#d84315,fill-opacity:0.18,stroke:#ff7043,stroke-width:2px
    style Claude fill:#c62828,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px,color:#fff
    style Custom fill:#880e4f,fill-opacity:0.18,stroke:#f06292,stroke-width:2px,color:#fff

    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

---

## 3.2 Layer 10: Distributed Network Layer (NEW)

**Status**: Design Phase (v0.2.0)  
**Documentation**: See `/docs/NETWORK_LAYER.md`, `/docs/FEDERATION_GUIDE.md`, `/docs/DISTRIBUTED_DEPLOYMENT.md`

Layer 10 adds distributed capabilities to RAGE, transforming it from a single-instance platform into a distributed knowledge network.

#### 3.2.1 Distributed Network Architecture

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    %% Main Layer 10 header
    L10["<b>Layer 10: Distributed Network</b>"]
    
    %% Core network components
    subgraph CoreNetwork[" "]
        direction LR
        P2P["üåê P2P Network<br/>libp2p Protocol"]
        CDN["‚ö° CDN Layer<br/>Multi-Provider"]
        FED["ü§ù Federation<br/>Cross-Org Queries"]
        SYNC["üîÑ Replication<br/>CRDTs + Sync"]
    end
    
    %% P2P Components group
    P2P_Title["<b>P2P Components</b>"]
    subgraph P2PBox[" "]
        direction LR
        DISC["Discovery<br/>Central + DHT + mDNS"]
        PEERS["Peer Management<br/>Connection Pool"]
        GOSSIP["Gossipsub<br/>Pub/Sub Messaging"]
        DHT["Kademlia DHT<br/>Content Routing"]
    end
    
    %% CDN Providers group
    CDN_Title["<b>CDN Providers</b>"]
    subgraph CDNBox[" "]
        direction LR
        CF["Cloudflare<br/>Americas"]
        FASTLY["Fastly<br/>Europe"]
        AWS_CF["CloudFront<br/>Asia/Pacific"]
        SELF["Self-Hosted<br/>Varnish/Nginx"]
    end
    
    %% Federation Services group
    FED_Title["<b>Federation Services</b>"]
    subgraph FEDBox[" "]
        direction LR
        TRUST["Trust Registry<br/>Explicit Lists"]
        ACL_FED["Federated ACL<br/>Cross-Node Validation"]
        ID_MAP["Identity Mapping<br/>External Users"]
    end
    
    %% Vertical flow
    L10 --> CoreNetwork
    
    CoreNetwork --> P2P_Title
    P2P_Title --> P2PBox
    
    CoreNetwork --> CDN_Title
    CDN_Title --> CDNBox
    
    CoreNetwork --> FED_Title
    FED_Title --> FEDBox
    
    %% Cross-connections between core components
    P2P -.-> CDN
    P2P -.-> FED
    P2P -.-> SYNC
    
    %% Styling
    classDef titleStyle fill:#263238,fill-opacity:0.3,stroke:#64b5f6,stroke-width:2px,font-weight:bold,font-size:16px;
    classDef networkStyle fill:#004d40,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px,stroke-dasharray:5 5;
    classDef p2pStyle fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:2px;
    classDef cdnStyle fill:#4a148c,fill-opacity:0.18,stroke:#ba68c8,stroke-width:2px;
    classDef fedStyle fill:#b71c1c,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px;
    classDef boxStyle fill:none,stroke:#64b5f6,stroke-width:2px,stroke-dasharray:5 5;
    
    class L10,P2P_Title,CDN_Title,FED_Title titleStyle;
    class P2P,CDN,FED,SYNC networkStyle;
    class DISC,PEERS,GOSSIP,DHT p2pStyle;
    class CF,FASTLY,AWS_CF,SELF cdnStyle;
    class TRUST,ACL_FED,ID_MAP fedStyle;
    class CoreNetwork,P2PBox,CDNBox,FEDBox boxStyle;
    
    linkStyle default stroke:#64b5f6,stroke-width:2px,curve:basis;
```

#### 3.2.2 P2P Network Topology

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 80, 'rankSpacing': 120, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
graph TB
    subgraph OrgA_Box["Organization A - Multi-Region (Cloud)"]
        direction LR
        A1[RAGE Node A1<br/>US West<br/>Primary]
        A2[RAGE Node A2<br/>US East<br/>Replica]
        A3[RAGE Node A3<br/>EU Central<br/>Replica]
    end
    
    subgraph OrgB_Box["Organization B - Federated Partner (On-Prem)"]
        B1[RAGE Node B1<br/>Partner Org]
    end
    
    CDN_GLOBAL[Multi-CDN<br/>Cloudflare + Fastly + CloudFront]
    
    subgraph Disc_Box["Discovery Servers"]
        direction LR
        DISC1[Discovery 1<br/>Bootstrap]
        DISC2[Discovery 2<br/>Fallback]
    end
    
    %% Internal mesh (within box)
    A1 <-->|P2P Full Mesh| A2
    A1 <-->|P2P Full Mesh| A3
    A2 <-->|P2P Full Mesh| A3
    
    %% Federation connection - routed through box boundary
    OrgA_Box <-.->|Federated Queries<br/>Explicit Trust| OrgB_Box
    
    %% CDN connections - separate vertical flow
    OrgA_Box --> CDN_GLOBAL
    OrgB_Box --> CDN_GLOBAL
    
    %% Discovery connections - routed to avoid crossing
    OrgA_Box -.->|Register + Heartbeat| DISC1
    OrgB_Box -.->|Register + Heartbeat| DISC2
    
    classDef boxStyle fill:none,stroke:#64b5f6,stroke-width:2px,stroke-dasharray:5 5;
    classDef nodeStyleA fill:#4CAF50,fill-opacity:0.18,stroke:#2e7d32,stroke-width:2px;
    classDef nodeStyleB fill:#2196F3,fill-opacity:0.18,stroke:#1565c0,stroke-width:2px;
    classDef nodeStyleCDN fill:#FF9800,fill-opacity:0.18,stroke:#ef6c00,stroke-width:2px;
    classDef nodeStyleDisc fill:#9C27B0,fill-opacity:0.18,stroke:#7b1fa2,stroke-width:2px;
    
    class OrgA_Box,OrgB_Box,Disc_Box boxStyle;
    class A1,A2,A3 nodeStyleA;
    class B1 nodeStyleB;
    class CDN_GLOBAL nodeStyleCDN;
    class DISC1,DISC2 nodeStyleDisc;

    linkStyle default stroke:#64b5f6,stroke-width:2px,curve:basis;
```

#### 3.2.3 Federated Query Flow

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'actorTextColor':'#fff', 'noteBkgColor':'#1a237e', 'noteTextColor':'#fff'}}}%%
sequenceDiagram
    participant User
    participant Node_A as RAGE Node A<br/>(Local)
    participant ACL_A as ACL Engine A
    participant Node_B as RAGE Node B<br/>(Remote/Federated)
    participant ACL_B as ACL Engine B
    
    User->>Node_A: Query: "How to handle refunds?"
    
    Node_A->>ACL_A: Check user permissions
    ACL_A-->>Node_A: User authorized for federated queries
    
    Node_A->>Node_A: Search local index
    Note over Node_A: Local results: 5 documents
    
    Node_A->>Node_B: POST /api/v1/federation/query<br/>{ query, user_context, filters }
    
    Node_B->>ACL_B: Map external user ‚Üí local identity
    ACL_B->>ACL_B: Check trust relationship
    ACL_B->>ACL_B: Validate federated access
    ACL_B-->>Node_B: Allowed with restrictions
    
    Node_B->>Node_B: Search local index (ACL-filtered)
    Note over Node_B: Remote results: 3 documents
    
    Node_B-->>Node_A: Return filtered results
    
    Node_A->>Node_A: Merge local + remote results
    Node_A->>Node_A: Re-rank combined results
    Node_A-->>User: Combined results: 8 documents
    
    Node_A->>Node_A: Log federated query to audit trail
```

#### 3.2.4 CDN Cache Flow

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart LR
    LB{Load Balancer} -->|Geographic Routing| CDN1[Cloudflare<br/>Americas]
    LB -->|Geographic Routing| CDN2[Fastly<br/>Europe]
    LB -->|Geographic Routing| CDN3[CloudFront<br/>Asia]
    
    CDN1 -->|Cache MISS| ORIGIN1[RAGE Node 1]
    CDN2 -->|Cache MISS| ORIGIN2[RAGE Node 2]
    
    ORIGIN1 --> P2P{P2P Network}
    ORIGIN2 --> P2P
    
    P2P -->|Replicated Content| ORIGIN1
    P2P -->|Replicated Content| ORIGIN2
    
    P2P -->|Replicated Content| ORIGIN3[RAGE Node 3]
    P2P --> ORIGIN3
    CDN3 -->|Cache MISS| ORIGIN3
    
    CDN2 -->|Cache HIT| USER[User Request]
    CDN1 -->|Cache HIT| USER
    CDN3 -->|Cache HIT| USER
    
    style CDN1 fill:#FF5722,fill-opacity:0.18
    style CDN2 fill:#9C27B0,fill-opacity:0.18
    style CDN3 fill:#FF9800,fill-opacity:0.18
    style P2P fill:#004D40,fill-opacity:0.18
```

#### 3.2.5 Content Replication Strategy

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    DOC[New Document Ingested] --> CHUNK[Chunk Document]
    
    CHUNK --> C1[Chunk 1<br/>hash: bafk...]
    CHUNK --> C2[Chunk 2<br/>hash: bafk...]
    CHUNK --> C3[Chunk 3<br/>hash: bafk...]
    
    C1 --> POLICY{Check Replication<br/>Policy}
    C2 --> POLICY
    C3 --> POLICY
    
    POLICY -->|Default: 3 replicas| SELECT[Select Target Nodes<br/>Geographic Diversity]
    POLICY -->|Critical: 5 replicas| SELECT
    POLICY -->|Ephemeral: 1 replica| SELECT
    
    SELECT --> N1[Node 1<br/>US West]
    SELECT --> N2[Node 2<br/>US East]
    SELECT --> N3[Node 3<br/>EU Central]
    SELECT --> N4[Node 4<br/>Asia Pacific]
    
    N1 -->|P2P Sync| GOSSIP[Gossipsub<br/>Pub/Sub]
    N2 -->|P2P Sync| GOSSIP
    N3 -->|P2P Sync| GOSSIP
    N4 -->|P2P Sync| GOSSIP
    
    GOSSIP -->|Announce| DHT[Kademlia DHT<br/>Content Routing]
    
    DHT --> CDN_PUSH[Push to CDN<br/>Edge Nodes]
    
    style POLICY fill:#FFC107,fill-opacity:0.18
    style GOSSIP fill:#3F51B5,fill-opacity:0.18
    style DHT fill:#009688,fill-opacity:0.18
```

#### 3.2.6 Trust Relationship Model

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
stateDiagram-v2
    [*] --> Pending: Admin initiates trust
    
    Pending --> Verifying: Certificate exchange
    Verifying --> Active: Mutual approval
    Verifying --> Rejected: Verification failed
    
    Active --> Suspended: Admin suspends
    Active --> Revoked: Trust removed
    
    Suspended --> Active: Admin reactivates
    Suspended --> Revoked: Trust removed permanently
    
    Rejected --> [*]
    Revoked --> [*]
    
    note right of Active
        Capabilities enabled:
        - Federated queries
        - Selective replication
        - ACL propagation
    end note
    
    note right of Suspended
        Temporary pause:
        - No new queries
        - Existing sessions continue
        - Can be reactivated
    end note
```

#### 3.2.7 Layer 10 Components Summary

| Component | Technology | Purpose |
|-----------|------------|---------|
| **P2P Protocol** | libp2p (Rust) | Peer-to-peer networking, NAT traversal |
| **Discovery** | Central servers + Kademlia DHT + mDNS | Node discovery and bootstrap |
| **Messaging** | Gossipsub | Pub/sub for ACL updates, sync events |
| **Content Routing** | Kad-DHT | Find providers for content chunks |
| **CDN (Commercial)** | Cloudflare, Fastly, AWS CloudFront | Global content delivery |
| **CDN (Self-Hosted)** | Varnish, Nginx | Private/VPN content delivery |
| **Trust Management** | PostgreSQL + X.509 certificates | Explicit trust lists, federated auth |
| **Replication** | CRDTs (Automerge) | Conflict-free data synchronization |
| **Identity Mapping** | PostgreSQL + SAML (future) | External user ‚Üí local identity |
| **Encryption** | Noise Protocol, TLS 1.3 | End-to-end P2P encryption |

#### 3.2.8 Network Metrics & Monitoring

Key metrics exposed by Layer 10:

- `rage_network_peers_total` - Number of connected peers
- `rage_network_latency_seconds` - P2P message round-trip time
- `rage_cdn_cache_hit_ratio` - CDN cache effectiveness
- `rage_replication_lag_seconds` - Data sync delay between nodes
- `rage_federation_queries_total` - Cross-org query volume
- `rage_federation_acl_denials_total` - Access control denials

See `/docs/MONITORING.md` for complete metrics and Grafana dashboards.

---

## 4. Component Interactions

### 4.1 Query Processing Flow (Mermaid Sequence Diagram)

```mermaid
%%{init: {'theme':'dark', 'themeVariables': {'actorTextColor':'#fff', 'noteBkgColor':'#1a237e', 'noteTextColor':'#fff'}}}%%
sequenceDiagram
    title Query Processing Flow
    actor User
    participant UI as Frontend UI<br/>(Mantine)
    participant Gateway as API Gateway<br/>(Nginx)
    participant API as FastAPI<br/>Query Router
    participant Cache as Valkey<br/>(Cache)
    participant Orch as Query<br/>Orchestrator
    participant CM as Concept<br/>Mapper
    participant DR as Document<br/>Retriever
    participant AS as Answer<br/>Synthesizer
    participant QA as Query<br/>Analyzer
    participant Neo4j as Neo4j<br/>(Graph DB)
    participant PG as PostgreSQL<br/>(Metadata)
    participant LLM as LLM Router<br/>(Ollama/OpenAI)

    User->>UI: 1. Submit Query
    UI->>Gateway: 2. POST /api/v1/query
    Gateway->>API: 3. Route + Auth
    API->>Cache: 4. Check Cache
    alt Cache Hit
        Cache-->>API: Return Cached Answer
        API-->>UI: 9. JSON Response
        UI-->>User: Display Answer
    else Cache Miss
        API->>Orch: 5. Distribute Tasks (MCP)
        
        par Parallel Agent Execution
            Orch->>CM: 6a. Extract Concepts
            CM->>Neo4j: Query Concepts
            Neo4j-->>CM: Concept Nodes
            
            Orch->>DR: 6b. Search Documents
            DR->>Neo4j: Vector + Graph Search
            DR->>PG: Metadata Query
            Neo4j-->>DR: Results
            PG-->>DR: Results
            
            Orch->>AS: 6c. Generate Answer
            AS->>LLM: Generate with Context
            LLM-->>AS: Answer + Citations
            
            Orch->>QA: 6d. Analyze Intent
            QA-->>Orch: Intent Analysis
        end
        
        CM-->>Orch: 7. Concept Results
        DR-->>Orch: 7. Document Results
        AS-->>Orch: 7. Generated Answer
        
        Orch->>Orch: 8. Aggregate Results
        Orch->>Cache: Cache Result
        Orch-->>API: Combined Result
        API-->>UI: 9. JSON Response
        UI-->>User: Display Answer
    end
```

### 4.2 Query Processing Flow (3D Architecture View)

```mermaid
%%{init: {'theme': 'base'}}%%
graph TB
    %% Title: 3D Architecture Layers
    subgraph Layer_1["Layer 1: Presentation"]
        class Layer_1 sameWidth;
        User[üë§ User]
        UI[üñ•Ô∏è Frontend UI<br/>React + Mantine]
    end

    subgraph Layer_2["Layer 2: Gateway"]
        class Layer_2 sameWidth;
        Gateway[üö™ API Gateway<br/>Nginx/Traefik<br/>SSL + Load Balancer]
    end

    subgraph Layer_3["Layer 3: Application"]
        class Layer_3 sameWidth;
        API[‚ö° FastAPI<br/>Query Router<br/>Auth + Validation]
        Cache{üíæ Valkey Cache<br/>Exact + Semantic}
    end

    subgraph Layer_4["Layer 4: Orchestration"]
        class Layer_4 sameWidth;
        Orch[üéØ Query Orchestrator<br/>MCP Coordinator]
    end

    subgraph Layer_5["Layer 5: Agent Network"]
        class Layer_5 sameWidth;
        direction LR
        CM[üß† Concept<br/>Mapper<br/>NER + Relations]
        DR[üìö Document<br/>Retriever<br/>Hybrid Search]
        AS[‚úçÔ∏è Answer<br/>Synthesizer<br/>LLM Generation]
        QA[üîç Query<br/>Analyzer<br/>Intent Detection]
    end

    subgraph Layer_6["Layer 6: Data Storage"]
        class Layer_6 sameWidth;
        direction LR
        Neo4j[(üï∏Ô∏è Neo4j<br/>Knowledge Graph<br/>Vectors + Relations)]
        PG[(üóÑÔ∏è PostgreSQL<br/>Structured Data<br/>Metadata)]
    end

    subgraph Layer_7["Layer 7: LLM Providers"]
        class Layer_7 sameWidth;
        direction LR
        Ollama[ü¶ô Ollama<br/>Local Models]
        OpenAI[ü§ñ OpenAI<br/>GPT-4]
        Claude[üé≠ Anthropic<br/>Claude]
        Custom[‚öôÔ∏è Custom<br/>Endpoints]
    end

    User -->|Submit Query| UI
    UI -->|HTTPS| Gateway
    Gateway -->|Route| API
    API -->|Check| Cache
    Cache -.->|Hit| API
    Cache -->|Miss| Orch

    Orch -->|MCP Tasks| CM
    Orch -->|MCP Tasks| DR
    Orch -->|MCP Tasks| AS
    Orch -->|MCP Tasks| QA

    CM <-->|Cypher| Neo4j
    DR <-->|Cypher + SQL| Neo4j
    DR <-->|SQL| PG
    AS -->|Generate| Ollama
    AS -->|Generate| OpenAI
    AS -->|Generate| Claude
    AS -->|Generate| Custom

    CM -->|Results| Orch
    DR -->|Results| Orch
    AS -->|Results| Orch
    QA -->|Results| Orch

    Orch -->|Aggregate| API
    API -->|Cache| Cache
    API -->|Response| UI
    UI -->|Display| User

    style User fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:3px
    style UI fill:#1565c0,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px
    style Gateway fill:#0277bd,fill-opacity:0.18,stroke:#4fc3f7,stroke-width:2px
    style API fill:#01579b,fill-opacity:0.18,stroke:#4dd0e1,stroke-width:2px
    style Cache fill:#006064,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px
    style Orch fill:#004d40,fill-opacity:0.18,stroke:#26a69a,stroke-width:3px
    style CM fill:#1b5e20,fill-opacity:0.18,stroke:#66bb6a,stroke-width:2px
    style DR fill:#33691e,fill-opacity:0.18,stroke:#9ccc65,stroke-width:2px
    style AS fill:#827717,fill-opacity:0.18,stroke:#dce775,stroke-width:2px
    style QA fill:#f57f17,fill-opacity:0.18,stroke:#ffb74d,stroke-width:2px
    style Neo4j fill:#4a148c,fill-opacity:0.18,stroke:#ba68c8,stroke-width:2px
    style PG fill:#6a1b9a,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px
    style Ollama fill:#bf360c,fill-opacity:0.18,stroke:#ff8a65,stroke-width:2px
    style OpenAI fill:#d84315,fill-opacity:0.18,stroke:#ff7043,stroke-width:2px
    style Claude fill:#c62828,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px,color:#fff
    style Custom fill:#880e4f,fill-opacity:0.18,stroke:#f06292,stroke-width:2px,color:#fff

    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

---

## 3.2 Layer 10: Distributed Network Layer (NEW)

**Status**: Design Phase (v0.2.0)  
**Documentation**: See `/docs/NETWORK_LAYER.md`, `/docs/FEDERATION_GUIDE.md`, `/docs/DISTRIBUTED_DEPLOYMENT.md`

Layer 10 adds distributed capabilities to RAGE, transforming it from a single-instance platform into a distributed knowledge network.

#### 3.2.1 Distributed Network Architecture

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    %% Main Layer 10 header
    L10["<b>Layer 10: Distributed Network</b>"]
    
    %% Core network components
    subgraph CoreNetwork[" "]
        direction LR
        P2P["üåê P2P Network<br/>libp2p Protocol"]
        CDN["‚ö° CDN Layer<br/>Multi-Provider"]
        FED["ü§ù Federation<br/>Cross-Org Queries"]
        SYNC["üîÑ Replication<br/>CRDTs + Sync"]
    end
    
    %% P2P Components group
    P2P_Title["<b>P2P Components</b>"]
    subgraph P2PBox[" "]
        direction LR
        DISC["Discovery<br/>Central + DHT + mDNS"]
        PEERS["Peer Management<br/>Connection Pool"]
        GOSSIP["Gossipsub<br/>Pub/Sub Messaging"]
        DHT["Kademlia DHT<br/>Content Routing"]
    end
    
    %% CDN Providers group
    CDN_Title["<b>CDN Providers</b>"]
    subgraph CDNBox[" "]
        direction LR
        CF["Cloudflare<br/>Americas"]
        FASTLY["Fastly<br/>Europe"]
        AWS_CF["CloudFront<br/>Asia/Pacific"]
        SELF["Self-Hosted<br/>Varnish/Nginx"]
    end
    
    %% Federation Services group
    FED_Title["<b>Federation Services</b>"]
    subgraph FEDBox[" "]
        direction LR
        TRUST["Trust Registry<br/>Explicit Lists"]
        ACL_FED["Federated ACL<br/>Cross-Node Validation"]
        ID_MAP["Identity Mapping<br/>External Users"]
    end
    
    %% Vertical flow
    L10 --> CoreNetwork
    
    CoreNetwork --> P2P_Title
    P2P_Title --> P2PBox
    
    CoreNetwork --> CDN_Title
    CDN_Title --> CDNBox
    
    CoreNetwork --> FED_Title
    FED_Title --> FEDBox
    
    %% Cross-connections between core components
    P2P -.-> CDN
    P2P -.-> FED
    P2P -.-> SYNC
    
    %% Styling
    classDef titleStyle fill:#263238,fill-opacity:0.3,stroke:#64b5f6,stroke-width:2px,font-weight:bold,font-size:16px;
    classDef networkStyle fill:#004d40,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px,stroke-dasharray:5 5;
    classDef p2pStyle fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:2px;
    classDef cdnStyle fill:#4a148c,fill-opacity:0.18,stroke:#ba68c8,stroke-width:2px;
    classDef fedStyle fill:#b71c1c,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px;
    classDef boxStyle fill:none,stroke:#64b5f6,stroke-width:2px,stroke-dasharray:5 5;
    
    class L10,P2P_Title,CDN_Title,FED_Title titleStyle;
    class P2P,CDN,FED,SYNC networkStyle;
    class DISC,PEERS,GOSSIP,DHT p2pStyle;
    class CF,FASTLY,AWS_CF,SELF cdnStyle;
    class TRUST,ACL_FED,ID_MAP fedStyle;
    class CoreNetwork,P2PBox,CDNBox,FEDBox boxStyle;
    
    linkStyle default stroke:#64b5f6,stroke-width:2px,curve:basis;
```

#### 3.2.2 P2P Network Topology

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 80, 'rankSpacing': 120, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
graph TB
    subgraph OrgA_Box["Organization A - Multi-Region (Cloud)"]
        direction LR
        A1[RAGE Node A1<br/>US West<br/>Primary]
        A2[RAGE Node A2<br/>US East<br/>Replica]
        A3[RAGE Node A3<br/>EU Central<br/>Replica]
    end
    
    subgraph OrgB_Box["Organization B - Federated Partner (On-Prem)"]
        B1[RAGE Node B1<br/>Partner Org]
    end
    
    CDN_GLOBAL[Multi-CDN<br/>Cloudflare + Fastly + CloudFront]
    
    subgraph Disc_Box["Discovery Servers"]
        direction LR
        DISC1[Discovery 1<br/>Bootstrap]
        DISC2[Discovery 2<br/>Fallback]
    end
    
    %% Internal mesh (within box)
    A1 <-->|P2P Full Mesh| A2
    A1 <-->|P2P Full Mesh| A3
    A2 <-->|P2P Full Mesh| A3
    
    %% Federation connection - routed through box boundary
    OrgA_Box <-.->|Federated Queries<br/>Explicit Trust| OrgB_Box
    
    %% CDN connections - separate vertical flow
    OrgA_Box --> CDN_GLOBAL
    OrgB_Box --> CDN_GLOBAL
    
    %% Discovery connections - routed to avoid crossing
    OrgA_Box -.->|Register + Heartbeat| DISC1
    OrgB_Box -.->|Register + Heartbeat| DISC2
    
    classDef boxStyle fill:none,stroke:#64b5f6,stroke-width:2px,stroke-dasharray:5 5;
    classDef nodeStyleA fill:#4CAF50,fill-opacity:0.18,stroke:#2e7d32,stroke-width:2px;
    classDef nodeStyleB fill:#2196F3,fill-opacity:0.18,stroke:#1565c0,stroke-width:2px;
    classDef nodeStyleCDN fill:#FF9800,fill-opacity:0.18,stroke:#ef6c00,stroke-width:2px;
    classDef nodeStyleDisc fill:#9C27B0,fill-opacity:0.18,stroke:#7b1fa2,stroke-width:2px;
    
    class OrgA_Box,OrgB_Box,Disc_Box boxStyle;
    class A1,A2,A3 nodeStyleA;
    class B1 nodeStyleB;
    class CDN_GLOBAL nodeStyleCDN;
    class DISC1,DISC2 nodeStyleDisc;

    linkStyle default stroke:#64b5f6,stroke-width:2px,curve:basis;
```

#### 3.2.3 Federated Query Flow

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'actorTextColor':'#fff', 'noteBkgColor':'#1a237e', 'noteTextColor':'#fff'}}}%%
sequenceDiagram
    participant User
    participant Node_A as RAGE Node A<br/>(Local)
    participant ACL_A as ACL Engine A
    participant Node_B as RAGE Node B<br/>(Remote/Federated)
    participant ACL_B as ACL Engine B
    
    User->>Node_A: Query: "How to handle refunds?"
    
    Node_A->>ACL_A: Check user permissions
    ACL_A-->>Node_A: User authorized for federated queries
    
    Node_A->>Node_A: Search local index
    Note over Node_A: Local results: 5 documents
    
    Node_A->>Node_B: POST /api/v1/federation/query<br/>{ query, user_context, filters }
    
    Node_B->>ACL_B: Map external user ‚Üí local identity
    ACL_B->>ACL_B: Check trust relationship
    ACL_B->>ACL_B: Validate federated access
    ACL_B-->>Node_B: Allowed with restrictions
    
    Node_B->>Node_B: Search local index (ACL-filtered)
    Note over Node_B: Remote results: 3 documents
    
    Node_B-->>Node_A: Return filtered results
    
    Node_A->>Node_A: Merge local + remote results
    Node_A->>Node_A: Re-rank combined results
    Node_A-->>User: Combined results: 8 documents
    
    Node_A->>Node_A: Log federated query to audit trail
```

#### 3.2.4 CDN Cache Flow

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart LR
    LB{Load Balancer} -->|Geographic Routing| CDN1[Cloudflare<br/>Americas]
    LB -->|Geographic Routing| CDN2[Fastly<br/>Europe]
    LB -->|Geographic Routing| CDN3[CloudFront<br/>Asia]
    
    CDN1 -->|Cache MISS| ORIGIN1[RAGE Node 1]
    CDN2 -->|Cache MISS| ORIGIN2[RAGE Node 2]
    
    ORIGIN1 --> P2P{P2P Network}
    ORIGIN2 --> P2P
    
    P2P -->|Replicated Content| ORIGIN1
    P2P -->|Replicated Content| ORIGIN2
    
    P2P -->|Replicated Content| ORIGIN3[RAGE Node 3]
    P2P --> ORIGIN3
    CDN3 -->|Cache MISS| ORIGIN3
    
    CDN2 -->|Cache HIT| USER[User Request]
    CDN1 -->|Cache HIT| USER
    CDN3 -->|Cache HIT| USER
    
    style CDN1 fill:#FF5722,fill-opacity:0.18
    style CDN2 fill:#9C27B0,fill-opacity:0.18
    style CDN3 fill:#FF9800,fill-opacity:0.18
    style P2P fill:#004D40,fill-opacity:0.18
```

#### 3.2.5 Content Replication Strategy

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    DOC[New Document Ingested] --> CHUNK[Chunk Document]
    
    CHUNK --> C1[Chunk 1<br/>hash: bafk...]
    CHUNK --> C2[Chunk 2<br/>hash: bafk...]
    CHUNK --> C3[Chunk 3<br/>hash: bafk...]
    
    C1 --> POLICY{Check Replication<br/>Policy}
    C2 --> POLICY
    C3 --> POLICY
    
    POLICY -->|Default: 3 replicas| SELECT[Select Target Nodes<br/>Geographic Diversity]
    POLICY -->|Critical: 5 replicas| SELECT
    POLICY -->|Ephemeral: 1 replica| SELECT
    
    SELECT --> N1[Node 1<br/>US West]
    SELECT --> N2[Node 2<br/>US East]
    SELECT --> N3[Node 3<br/>EU Central]
    SELECT --> N4[Node 4<br/>Asia Pacific]
    
    N1 -->|P2P Sync| GOSSIP[Gossipsub<br/>Pub/Sub]
    N2 -->|P2P Sync| GOSSIP
    N3 -->|P2P Sync| GOSSIP
    N4 -->|P2P Sync| GOSSIP
    
    GOSSIP -->|Announce| DHT[Kademlia DHT<br/>Content Routing]
    
    DHT --> CDN_PUSH[Push to CDN<br/>Edge Nodes]
    
    style POLICY fill:#FFC107,fill-opacity:0.18
    style GOSSIP fill:#3F51B5,fill-opacity:0.18
    style DHT fill:#009688,fill-opacity:0.18
```

#### 3.2.6 Trust Relationship Model

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
stateDiagram-v2
    [*] --> Pending: Admin initiates trust
    
    Pending --> Verifying: Certificate exchange
    Verifying --> Active: Mutual approval
    Verifying --> Rejected: Verification failed
    
    Active --> Suspended: Admin suspends
    Active --> Revoked: Trust removed
    
    Suspended --> Active: Admin reactivates
    Suspended --> Revoked: Trust removed permanently
    
    Rejected --> [*]
    Revoked --> [*]
    
    note right of Active
        Capabilities enabled:
        - Federated queries
        - Selective replication
        - ACL propagation
    end note
    
    note right of Suspended
        Temporary pause:
        - No new queries
        - Existing sessions continue
        - Can be reactivated
    end note
```

#### 3.2.7 Layer 10 Components Summary

| Component | Technology | Purpose |
|-----------|------------|---------|
| **P2P Protocol** | libp2p (Rust) | Peer-to-peer networking, NAT traversal |
| **Discovery** | Central servers + Kademlia DHT + mDNS | Node discovery and bootstrap |
| **Messaging** | Gossipsub | Pub/sub for ACL updates, sync events |
| **Content Routing** | Kad-DHT | Find providers for content chunks |
| **CDN (Commercial)** | Cloudflare, Fastly, AWS CloudFront | Global content delivery |
| **CDN (Self-Hosted)** | Varnish, Nginx | Private/VPN content delivery |
| **Trust Management** | PostgreSQL + X.509 certificates | Explicit trust lists, federated auth |
| **Replication** | CRDTs (Automerge) | Conflict-free data synchronization |
| **Identity Mapping** | PostgreSQL + SAML (future) | External user ‚Üí local identity |
| **Encryption** | Noise Protocol, TLS 1.3 | End-to-end P2P encryption |

#### 3.2.8 Network Metrics & Monitoring

Key metrics exposed by Layer 10:

- `rage_network_peers_total` - Number of connected peers
- `rage_network_latency_seconds` - P2P message round-trip time
- `rage_cdn_cache_hit_ratio` - CDN cache effectiveness
- `rage_replication_lag_seconds` - Data sync delay between nodes
- `rage_federation_queries_total` - Cross-org query volume
- `rage_federation_acl_denials_total` - Access control denials

See `/docs/MONITORING.md` for complete metrics and Grafana dashboards.

---

## 4. Component Interactions

### 4.1 Query Processing Flow (Mermaid Sequence Diagram)

```mermaid
%%{init: {'theme':'dark', 'themeVariables': {'actorTextColor':'#fff', 'noteBkgColor':'#1a237e', 'noteTextColor':'#fff'}}}%%
sequenceDiagram
    title Query Processing Flow
    actor User
    participant UI as Frontend UI<br/>(Mantine)
    participant Gateway as API Gateway<br/>(Nginx)
    participant API as FastAPI<br/>Query Router
    participant Cache as Valkey<br/>(Cache)
    participant Orch as Query<br/>Orchestrator
    participant CM as Concept<br/>Mapper
    participant DR as Document<br/>Retriever
    participant AS as Answer<br/>Synthesizer
    participant QA as Query<br/>Analyzer
    participant Neo4j as Neo4j<br/>(Graph DB)
    participant PG as PostgreSQL<br/>(Metadata)
    participant LLM as LLM Router<br/>(Ollama/OpenAI)

    User->>UI: 1. Submit Query
    UI->>Gateway: 2. POST /api/v1/query
    Gateway->>API: 3. Route + Auth
    API->>Cache: 4. Check Cache
    alt Cache Hit
        Cache-->>API: Return Cached Answer
        API-->>UI: 9. JSON Response
        UI-->>User: Display Answer
    else Cache Miss
        API->>Orch: 5. Distribute Tasks (MCP)
        
        par Parallel Agent Execution
            Orch->>CM: 6a. Extract Concepts
            CM->>Neo4j: Query Concepts
            Neo4j-->>CM: Concept Nodes
            
            Orch->>DR: 6b. Search Documents
            DR->>Neo4j: Vector + Graph Search
            DR->>PG: Metadata Query
            Neo4j-->>DR: Results
            PG-->>DR: Results
            
            Orch->>AS: 6c. Generate Answer
            AS->>LLM: Generate with Context
            LLM-->>AS: Answer + Citations
            
            Orch->>QA: 6d. Analyze Intent
            QA-->>Orch: Intent Analysis
        end
        
        CM-->>Orch: 7. Concept Results
        DR-->>Orch: 7. Document Results
        AS-->>Orch: 7. Generated Answer
        
        Orch->>Orch: 8. Aggregate Results
        Orch->>Cache: Cache Result
        Orch-->>API: Combined Result
        API-->>UI: 9. JSON Response
        UI-->>User: Display Answer
    end
```

### 4.2 Query Processing Flow (3D Architecture View)

```mermaid
%%{init: {'theme': 'base'}}%%
graph TB
    %% Title: 3D Architecture Layers
    subgraph Layer_1["Layer 1: Presentation"]
        class Layer_1 sameWidth;
        User[üë§ User]
        UI[üñ•Ô∏è Frontend UI<br/>React + Mantine]
    end

    subgraph Layer_2["Layer 2: Gateway"]
        class Layer_2 sameWidth;
        Gateway[üö™ API Gateway<br/>Nginx/Traefik<br/>SSL + Load Balancer]
    end

    subgraph Layer_3["Layer 3: Application"]
        class Layer_3 sameWidth;
        API[‚ö° FastAPI<br/>Query Router<br/>Auth + Validation]
        Cache{üíæ Valkey Cache<br/>Exact + Semantic}
    end

    subgraph Layer_4["Layer 4: Orchestration"]
        class Layer_4 sameWidth;
        Orch[üéØ Query Orchestrator<br/>MCP Coordinator]
    end

    subgraph Layer_5["Layer 5: Agent Network"]
        class Layer_5 sameWidth;
        direction LR
        CM[üß† Concept<br/>Mapper<br/>NER + Relations]
        DR[üìö Document<br/>Retriever<br/>Hybrid Search]
        AS[‚úçÔ∏è Answer<br/>Synthesizer<br/>LLM Generation]
        QA[üîç Query<br/>Analyzer<br/>Intent Detection]
    end

    subgraph Layer_6["Layer 6: Data Storage"]
        class Layer_6 sameWidth;
        direction LR
        Neo4j[(üï∏Ô∏è Neo4j<br/>Knowledge Graph<br/>Vectors + Relations)]
        PG[(üóÑÔ∏è PostgreSQL<br/>Structured Data<br/>Metadata)]
    end

    subgraph Layer_7["Layer 7: LLM Providers"]
        class Layer_7 sameWidth;
        direction LR
        Ollama[ü¶ô Ollama<br/>Local Models]
        OpenAI[ü§ñ OpenAI<br/>GPT-4]
        Claude[üé≠ Anthropic<br/>Claude]
        Custom[‚öôÔ∏è Custom<br/>Endpoints]
    end

    User -->|Submit Query| UI
    UI -->|HTTPS| Gateway
    Gateway -->|Route| API
    API -->|Check| Cache
    Cache -.->|Hit| API
    Cache -->|Miss| Orch

    Orch -->|MCP Tasks| CM
    Orch -->|MCP Tasks| DR
    Orch -->|MCP Tasks| AS
    Orch -->|MCP Tasks| QA

    CM <-->|Cypher| Neo4j
    DR <-->|Cypher + SQL| Neo4j
    DR <-->|SQL| PG
    AS -->|Generate| Ollama
    AS -->|Generate| OpenAI
    AS -->|Generate| Claude
    AS -->|Generate| Custom

    CM -->|Results| Orch
    DR -->|Results| Orch
    AS -->|Results| Orch
    QA -->|Results| Orch

    Orch -->|Aggregate| API
    API -->|Cache| Cache
    API -->|Response| UI
    UI -->|Display| User

    style User fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:3px
    style UI fill:#1565c0,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px
    style Gateway fill:#0277bd,fill-opacity:0.18,stroke:#4fc3f7,stroke-width:2px
    style API fill:#01579b,fill-opacity:0.18,stroke:#4dd0e1,stroke-width:2px
    style Cache fill:#006064,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px
    style Orch fill:#004d40,fill-opacity:0.18,stroke:#26a69a,stroke-width:3px
    style CM fill:#1b5e20,fill-opacity:0.18,stroke:#66bb6a,stroke-width:2px
    style DR fill:#33691e,fill-opacity:0.18,stroke:#9ccc65,stroke-width:2px
    style AS fill:#827717,fill-opacity:0.18,stroke:#dce775,stroke-width:2px
    style QA fill:#f57f17,fill-opacity:0.18,stroke:#ffb74d,stroke-width:2px
    style Neo4j fill:#4a148c,fill-opacity:0.18,stroke:#ba68c8,stroke-width:2px
    style PG fill:#6a1b9a,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px
    style Ollama fill:#bf360c,fill-opacity:0.18,stroke:#ff8a65,stroke-width:2px
    style OpenAI fill:#d84315,fill-opacity:0.18,stroke:#ff7043,stroke-width:2px
    style Claude fill:#c62828,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px,color:#fff
    style Custom fill:#880e4f,fill-opacity:0.18,stroke:#f06292,stroke-width:2px,color:#fff

    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

---

## 3.2 Layer 10: Distributed Network Layer (NEW)

**Status**: Design Phase (v0.2.0)  
**Documentation**: See `/docs/NETWORK_LAYER.md`, `/docs/FEDERATION_GUIDE.md`, `/docs/DISTRIBUTED_DEPLOYMENT.md`

Layer 10 adds distributed capabilities to RAGE, transforming it from a single-instance platform into a distributed knowledge network.

#### 3.2.1 Distributed Network Architecture

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    %% Main Layer 10 header
    L10["<b>Layer 10: Distributed Network</b>"]
    
    %% Core network components
    subgraph CoreNetwork[" "]
        direction LR
        P2P["üåê P2P Network<br/>libp2p Protocol"]
        CDN["‚ö° CDN Layer<br/>Multi-Provider"]
        FED["ü§ù Federation<br/>Cross-Org Queries"]
        SYNC["üîÑ Replication<br/>CRDTs + Sync"]
    end
    
    %% P2P Components group
    P2P_Title["<b>P2P Components</b>"]
    subgraph P2PBox[" "]
        direction LR
        DISC["Discovery<br/>Central + DHT + mDNS"]
        PEERS["Peer Management<br/>Connection Pool"]
        GOSSIP["Gossipsub<br/>Pub/Sub Messaging"]
        DHT["Kademlia DHT<br/>Content Routing"]
    end
    
    %% CDN Providers group
    CDN_Title["<b>CDN Providers</b>"]
    subgraph CDNBox[" "]
        direction LR
        CF["Cloudflare<br/>Americas"]
        FASTLY["Fastly<br/>Europe"]
        AWS_CF["CloudFront<br/>Asia/Pacific"]
        SELF["Self-Hosted<br/>Varnish/Nginx"]
    end
    
    %% Federation Services group
    FED_Title["<b>Federation Services</b>"]
    subgraph FEDBox[" "]
        direction LR
        TRUST["Trust Registry<br/>Explicit Lists"]
        ACL_FED["Federated ACL<br/>Cross-Node Validation"]
        ID_MAP["Identity Mapping<br/>External Users"]
    end
    
    %% Vertical flow
    L10 --> CoreNetwork
    
    CoreNetwork --> P2P_Title
    P2P_Title --> P2PBox
    
    CoreNetwork --> CDN_Title
    CDN_Title --> CDNBox
    
    CoreNetwork --> FED_Title
    FED_Title --> FEDBox
    
    %% Cross-connections between core components
    P2P -.-> CDN
    P2P -.-> FED
    P2P -.-> SYNC
    
    %% Styling
    classDef titleStyle fill:#263238,fill-opacity:0.3,stroke:#64b5f6,stroke-width:2px,font-weight:bold,font-size:16px;
    classDef networkStyle fill:#004d40,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px,stroke-dasharray:5 5;
    classDef p2pStyle fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:2px;
    classDef cdnStyle fill:#4a148c,fill-opacity:0.18,stroke:#ba68c8,stroke-width:2px;
    classDef fedStyle fill:#b71c1c,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px;
    classDef boxStyle fill:none,stroke:#64b5f6,stroke-width:2px,stroke-dasharray:5 5;
    
    class L10,P2P_Title,CDN_Title,FED_Title titleStyle;
    class P2P,CDN,FED,SYNC networkStyle;
    class DISC,PEERS,GOSSIP,DHT p2pStyle;
    class CF,FASTLY,AWS_CF,SELF cdnStyle;
    class TRUST,ACL_FED,ID_MAP fedStyle;
    class CoreNetwork,P2PBox,CDNBox,FEDBox boxStyle;
    
    linkStyle default stroke:#64b5f6,stroke-width:2px,curve:basis;
```

#### 3.2.2 P2P Network Topology

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 80, 'rankSpacing': 120, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
graph TB
    subgraph OrgA_Box["Organization A - Multi-Region (Cloud)"]
        direction LR
        A1[RAGE Node A1<br/>US West<br/>Primary]
        A2[RAGE Node A2<br/>US East<br/>Replica]
        A3[RAGE Node A3<br/>EU Central<br/>Replica]
    end
    
    subgraph OrgB_Box["Organization B - Federated Partner (On-Prem)"]
        B1[RAGE Node B1<br/>Partner Org]
    end
    
    CDN_GLOBAL[Multi-CDN<br/>Cloudflare + Fastly + CloudFront]
    
    subgraph Disc_Box["Discovery Servers"]
        direction LR
        DISC1[Discovery 1<br/>Bootstrap]
        DISC2[Discovery 2<br/>Fallback]
    end
    
    %% Internal mesh (within box)
    A1 <-->|P2P Full Mesh| A2
    A1 <-->|P2P Full Mesh| A3
    A2 <-->|P2P Full Mesh| A3
    
    %% Federation connection - routed through box boundary
    OrgA_Box <-.->|Federated Queries<br/>Explicit Trust| OrgB_Box
    
    %% CDN connections - separate vertical flow
    OrgA_Box --> CDN_GLOBAL
    OrgB_Box --> CDN_GLOBAL
    
    %% Discovery connections - routed to avoid crossing
    OrgA_Box -.->|Register + Heartbeat| DISC1
    OrgB_Box -.->|Register + Heartbeat| DISC2
    
    classDef boxStyle fill:none,stroke:#64b5f6,stroke-width:2px,stroke-dasharray:5 5;
    classDef nodeStyleA fill:#4CAF50,fill-opacity:0.18,stroke:#2e7d32,stroke-width:2px;
    classDef nodeStyleB fill:#2196F3,fill-opacity:0.18,stroke:#1565c0,stroke-width:2px;
    classDef nodeStyleCDN fill:#FF9800,fill-opacity:0.18,stroke:#ef6c00,stroke-width:2px;
    classDef nodeStyleDisc fill:#9C27B0,fill-opacity:0.18,stroke:#7b1fa2,stroke-width:2px;
    
    class OrgA_Box,OrgB_Box,Disc_Box boxStyle;
    class A1,A2,A3 nodeStyleA;
    class B1 nodeStyleB;
    class CDN_GLOBAL nodeStyleCDN;
    class DISC1,DISC2 nodeStyleDisc;

    linkStyle default stroke:#64b5f6,stroke-width:2px,curve:basis;
```

#### 3.2.3 Federated Query Flow

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'actorTextColor':'#fff', 'noteBkgColor':'#1a237e', 'noteTextColor':'#fff'}}}%%
sequenceDiagram
    participant User
    participant Node_A as RAGE Node A<br/>(Local)
    participant ACL_A as ACL Engine A
    participant Node_B as RAGE Node B<br/>(Remote/Federated)
    participant ACL_B as ACL Engine B
    
    User->>Node_A: Query: "How to handle refunds?"
    
    Node_A->>ACL_A: Check user permissions
    ACL_A-->>Node_A: User authorized for federated queries
    
    Node_A->>Node_A: Search local index
    Note over Node_A: Local results: 5 documents
    
    Node_A->>Node_B: POST /api/v1/federation/query<br/>{ query, user_context, filters }
    
    Node_B->>ACL_B: Map external user ‚Üí local identity
    ACL_B->>ACL_B: Check trust relationship
    ACL_B->>ACL_B: Validate federated access
    ACL_B-->>Node_B: Allowed with restrictions
    
    Node_B->>Node_B: Search local index (ACL-filtered)
    Note over Node_B: Remote results: 3 documents
    
    Node_B-->>Node_A: Return filtered results
    
    Node_A->>Node_A: Merge local + remote results
    Node_A->>Node_A: Re-rank combined results
    Node_A-->>User: Combined results: 8 documents
    
    Node_A->>Node_A: Log federated query to audit trail
```

#### 3.2.4 CDN Cache Flow

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart LR
    LB{Load Balancer} -->|Geographic Routing| CDN1[Cloudflare<br/>Americas]
    LB -->|Geographic Routing| CDN2[Fastly<br/>Europe]
    LB -->|Geographic Routing| CDN3[CloudFront<br/>Asia]
    
    CDN1 -->|Cache MISS| ORIGIN1[RAGE Node 1]
    CDN2 -->|Cache MISS| ORIGIN2[RAGE Node 2]
    
    ORIGIN1 --> P2P{P2P Network}
    ORIGIN2 --> P2P
    
    P2P -->|Replicated Content| ORIGIN1
    P2P -->|Replicated Content| ORIGIN2
    
    P2P -->|Replicated Content| ORIGIN3[RAGE Node 3]
    P2P --> ORIGIN3
    CDN3 -->|Cache MISS| ORIGIN3
    
    CDN2 -->|Cache HIT| USER[User Request]
    CDN1 -->|Cache HIT| USER
    CDN3 -->|Cache HIT| USER
    
    style CDN1 fill:#FF5722,fill-opacity:0.18
    style CDN2 fill:#9C27B0,fill-opacity:0.18
    style CDN3 fill:#FF9800,fill-opacity:0.18
    style P2P fill:#004D40,fill-opacity:0.18
```

#### 3.2.5 Content Replication Strategy

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    DOC[New Document Ingested] --> CHUNK[Chunk Document]
    
    CHUNK --> C1[Chunk 1<br/>hash: bafk...]
    CHUNK --> C2[Chunk 2<br/>hash: bafk...]
    CHUNK --> C3[Chunk 3<br/>hash: bafk...]
    
    C1 --> POLICY{Check Replication<br/>Policy}
    C2 --> POLICY
    C3 --> POLICY
    
    POLICY -->|Default: 3 replicas| SELECT[Select Target Nodes<br/>Geographic Diversity]
    POLICY -->|Critical: 5 replicas| SELECT
    POLICY -->|Ephemeral: 1 replica| SELECT
    
    SELECT --> N1[Node 1<br/>US West]
    SELECT --> N2[Node 2<br/>US East]
    SELECT --> N3[Node 3<br/>EU Central]
    SELECT --> N4[Node 4<br/>Asia Pacific]
    
    N1 -->|P2P Sync| GOSSIP[Gossipsub<br/>Pub/Sub]
    N2 -->|P2P Sync| GOSSIP
    N3 -->|P2P Sync| GOSSIP
    N4 -->|P2P Sync| GOSSIP
    
    GOSSIP -->|Announce| DHT[Kademlia DHT<br/>Content Routing]
    
    DHT --> CDN_PUSH[Push to CDN<br/>Edge Nodes]
    
    style POLICY fill:#FFC107,fill-opacity:0.18
    style GOSSIP fill:#3F51B5,fill-opacity:0.18
    style DHT fill:#009688,fill-opacity:0.18
```

#### 3.2.6 Trust Relationship Model

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
stateDiagram-v2
    [*] --> Pending: Admin initiates trust
    
    Pending --> Verifying: Certificate exchange
    Verifying --> Active: Mutual approval
    Verifying --> Rejected: Verification failed
    
    Active --> Suspended: Admin suspends
    Active --> Revoked: Trust removed
    
    Suspended --> Active: Admin reactivates
    Suspended --> Revoked: Trust removed permanently
    
    Rejected --> [*]
    Revoked --> [*]
    
    note right of Active
        Capabilities enabled:
        - Federated queries
        - Selective replication
        - ACL propagation
    end note
    
    note right of Suspended
        Temporary pause:
        - No new queries
        - Existing sessions continue
        - Can be reactivated
    end note
```

#### 3.2.7 Layer 10 Components Summary

| Component | Technology | Purpose |
|-----------|------------|---------|
| **P2P Protocol** | libp2p (Rust) | Peer-to-peer networking, NAT traversal |
| **Discovery** | Central servers + Kademlia DHT + mDNS | Node discovery and bootstrap |
| **Messaging** | Gossipsub | Pub/sub for ACL updates, sync events |
| **Content Routing** | Kad-DHT | Find providers for content chunks |
| **CDN (Commercial)** | Cloudflare, Fastly, AWS CloudFront | Global content delivery |
| **CDN (Self-Hosted)** | Varnish, Nginx | Private/VPN content delivery |
| **Trust Management** | PostgreSQL + X.509 certificates | Explicit trust lists, federated auth |
| **Replication** | CRDTs (Automerge) | Conflict-free data synchronization |
| **Identity Mapping** | PostgreSQL + SAML (future) | External user ‚Üí local identity |
| **Encryption** | Noise Protocol, TLS 1.3 | End-to-end P2P encryption |

#### 3.2.8 Network Metrics & Monitoring

Key metrics exposed by Layer 10:

- `rage_network_peers_total` - Number of connected peers
- `rage_network_latency_seconds` - P2P message round-trip time
- `rage_cdn_cache_hit_ratio` - CDN cache effectiveness
- `rage_replication_lag_seconds` - Data sync delay between nodes
- `rage_federation_queries_total` - Cross-org query volume
- `rage_federation_acl_denials_total` - Access control denials

See `/docs/MONITORING.md` for complete metrics and Grafana dashboards.

---

## 4. Component Interactions

### 4.1 Query Processing Flow (Mermaid Sequence Diagram)

```mermaid
%%{init: {'theme':'dark', 'themeVariables': {'actorTextColor':'#fff', 'noteBkgColor':'#1a237e', 'noteTextColor':'#fff'}}}%%
sequenceDiagram
    title Query Processing Flow
    actor User
    participant UI as Frontend UI<br/>(Mantine)
    participant Gateway as API Gateway<br/>(Nginx)
    participant API as FastAPI<br/>Query Router
    participant Cache as Valkey<br/>(Cache)
    participant Orch as Query<br/>Orchestrator
    participant CM as Concept<br/>Mapper
    participant DR as Document<br/>Retriever
    participant AS as Answer<br/>Synthesizer
    participant QA as Query<br/>Analyzer
    participant Neo4j as Neo4j<br/>(Graph DB)
    participant PG as PostgreSQL<br/>(Metadata)
    participant LLM as LLM Router<br/>(Ollama/OpenAI)

    User->>UI: 1. Submit Query
    UI->>Gateway: 2. POST /api/v1/query
    Gateway->>API: 3. Route + Auth
    API->>Cache: 4. Check Cache
    alt Cache Hit
        Cache-->>API: Return Cached Answer
        API-->>UI: 9. JSON Response
        UI-->>User: Display Answer
    else Cache Miss
        API->>Orch: 5. Distribute Tasks (MCP)
        
        par Parallel Agent Execution
            Orch->>CM: 6a. Extract Concepts
            CM->>Neo4j: Query Concepts
            Neo4j-->>CM: Concept Nodes
            
            Orch->>DR: 6b. Search Documents
            DR->>Neo4j: Vector + Graph Search
            DR->>PG: Metadata Query
            Neo4j-->>DR: Results
            PG-->>DR: Results
            
            Orch->>AS: 6c. Generate Answer
            AS->>LLM: Generate with Context
            LLM-->>AS: Answer + Citations
            
            Orch->>QA: 6d. Analyze Intent
            QA-->>Orch: Intent Analysis
        end
        
        CM-->>Orch: 7. Concept Results
        DR-->>Orch: 7. Document Results
        AS-->>Orch: 7. Generated Answer
        
        Orch->>Orch: 8. Aggregate Results
        Orch->>Cache: Cache Result
        Orch-->>API: Combined Result
        API-->>UI: 9. JSON Response
        UI-->>User: Display Answer
    end
```

### 4.2 Query Processing Flow (3D Architecture View)

```mermaid
%%{init: {'theme': 'base'}}%%
graph TB
    %% Title: 3D Architecture Layers
    subgraph Layer_1["Layer 1: Presentation"]
        class Layer_1 sameWidth;
        User[üë§ User]
        UI[üñ•Ô∏è Frontend UI<br/>React + Mantine]
    end

    subgraph Layer_2["Layer 2: Gateway"]
        class Layer_2 sameWidth;
        Gateway[üö™ API Gateway<br/>Nginx/Traefik<br/>SSL + Load Balancer]
    end

    subgraph Layer_3["Layer 3: Application"]
        class Layer_3 sameWidth;
        API[‚ö° FastAPI<br/>Query Router<br/>Auth + Validation]
        Cache{üíæ Valkey Cache<br/>Exact + Semantic}
    end

    subgraph Layer_4["Layer 4: Orchestration"]
        class Layer_4 sameWidth;
        Orch[üéØ Query Orchestrator<br/>MCP Coordinator]
    end

    subgraph Layer_5["Layer 5: Agent Network"]
        class Layer_5 sameWidth;
        direction LR
        CM[üß† Concept<br/>Mapper<br/>NER + Relations]
        DR[üìö Document<br/>Retriever<br/>Hybrid Search]
        AS[‚úçÔ∏è Answer<br/>Synthesizer<br/>LLM Generation]
        QA[üîç Query<br/>Analyzer<br/>Intent Detection]
    end

    subgraph Layer_6["Layer 6: Data Storage"]
        class Layer_6 sameWidth;
        direction LR
        Neo4j[(üï∏Ô∏è Neo4j<br/>Knowledge Graph<br/>Vectors + Relations)]
        PG[(üóÑÔ∏è PostgreSQL<br/>Structured Data<br/>Metadata)]
    end

    subgraph Layer_7["Layer 7: LLM Providers"]
        class Layer_7 sameWidth;
        direction LR
        Ollama[ü¶ô Ollama<br/>Local Models]
        OpenAI[ü§ñ OpenAI<br/>GPT-4]
        Claude[üé≠ Anthropic<br/>Claude]
        Custom[‚öôÔ∏è Custom<br/>Endpoints]
    end

    User -->|Submit Query| UI
    UI -->|HTTPS| Gateway
    Gateway -->|Route| API
    API -->|Check| Cache
    Cache -.->|Hit| API
    Cache -->|Miss| Orch

    Orch -->|MCP Tasks| CM
    Orch -->|MCP Tasks| DR
    Orch -->|MCP Tasks| AS
    Orch -->|MCP Tasks| QA

    CM <-->|Cypher| Neo4j
    DR <-->|Cypher + SQL| Neo4j
    DR <-->|SQL| PG
    AS -->|Generate| Ollama
    AS -->|Generate| OpenAI
    AS -->|Generate| Claude
    AS -->|Generate| Custom

    CM -->|Results| Orch
    DR -->|Results| Orch
    AS -->|Results| Orch
    QA -->|Results| Orch

    Orch -->|Aggregate| API
    API -->|Cache| Cache
    API -->|Response| UI
    UI -->|Display| User

    style User fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:3px
    style UI fill:#1565c0,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px
    style Gateway fill:#0277bd,fill-opacity:0.18,stroke:#4fc3f7,stroke-width:2px
    style API fill:#01579b,fill-opacity:0.18,stroke:#4dd0e1,stroke-width:2px
    style Cache fill:#006064,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px
    style Orch fill:#004d40,fill-opacity:0.18,stroke:#26a69a,stroke-width:3px
    style CM fill:#1b5e20,fill-opacity:0.18,stroke:#66bb6a,stroke-width:2px
    style DR fill:#33691e,fill-opacity:0.18,stroke:#9ccc65,stroke-width:2px
    style AS fill:#827717,fill-opacity:0.18,stroke:#dce775,stroke-width:2px
    style QA fill:#f57f17,fill-opacity:0.18,stroke:#ffb74d,stroke-width:2px
    style Neo4j fill:#4a148c,fill-opacity:0.18,stroke:#ba68c8,stroke-width:2px
    style PG fill:#6a1b9a,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px
    style Ollama fill:#bf360c,fill-opacity:0.18,stroke:#ff8a65,stroke-width:2px
    style OpenAI fill:#d84315,fill-opacity:0.18,stroke:#ff7043,stroke-width:2px
    style Claude fill:#c62828,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px,color:#fff
    style Custom fill:#880e4f,fill-opacity:0.18,stroke:#f06292,stroke-width:2px,color:#fff

    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

---

## 3.2.1.1 Layer 8: AI Orchestration Layer (NEW)

**Status**: Design Phase (v0.2.0)  
**Documentation**: See `/docs/AI_ORCHESTRATION_LAYER.md`

Layer 8 introduces an AI Orchestration Layer to manage complex workflows and agent collaborations.

#### 3.2.1.1.1 AI Orchestration Architecture

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    %% Main Layer 8 header
    L8["<b>Layer 8: AI Orchestration</b>"]
    
    %% Core orchestration components
    subgraph CoreOrch[" "]
        direction LR
        TRIGGER["‚öôÔ∏è Event Trigger<br/>Document ingested<br/>Query received"]
        FLOW["üß† Workflow Engine<br/>Manage AI workflows"]
        TASK["üìã Task Queue<br/>Distributed task management"]
        RESULT["üì¶ Result Store<br/>Intermediate results"]
    end
    
    %% Workflow examples
    subgraph Workflows[" "]
        direction TB
        W1["üîÑ Workflow 1: Ingest & Analyze"]
        W2["üìä Workflow 2: Report Generation"]
        W3["üîî Workflow 3: Alerting"]
    end
    
    TRIGGER --> FLOW
    FLOW --> TASK
    TASK --> RESULT
    
    %% Example workflow triggers
    TRIGGER -.->|Document Ingested| W1
    TRIGGER -.->|New Query| W1
    TRIGGER -.->|Daily Schedule| W2
    TRIGGER -.->|Threshold Alert| W3
    
    %% Styling
    classDef titleStyle fill:#263238,fill-opacity:0.3,stroke:#64b5f6,stroke-width:2px,font-weight:bold,font-size:16px;
    classDef coreStyle fill:#004d40,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px;
    classDef wfStyle fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:2px;
    
    class L8,titleStyle;
    class TRIGGER,FLOW,TASK,RESULT coreStyle;
    class W1,W2,W3 wfStyle;
    
    linkStyle default stroke:#64b5f6,stroke-width:2px,curve:basis;
```

#### 3.2.1.1.2 Event-Driven Workflow Example

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    %% Title: Event-Driven Workflow - Document Ingestion to Analysis
    TRIGGER["üì• Document Ingested<br/>File: report.pdf"]
    
    PARSE["1Ô∏è‚É£ Parse Document<br/>Extract text, metadata"]
    
    CHUNK["2Ô∏è‚É£ Chunk Text<br/>Size: 512 tokens<br/>Overlap: 50"]
    
    EMBED["3Ô∏è‚É£ Generate Embeddings<br/>Model: nomic-embed-text"]
    
    STORE["4Ô∏è‚É£ Store Metadata + Vectors"]
    
    INDEX["5Ô∏è‚É£ Update Search Index<br/>Add document to vector DB"]
    
    NOTIFY["6Ô∏è‚É£ Notify Completion<br/>User: user@example.com"]
    
    TRIGGER --> PARSE
    PARSE --> CHUNK
    CHUNK --> EMBED
    EMBED --> STORE
    STORE --> INDEX
    INDEX --> NOTIFY
    
    style TRIGGER fill:#0d47a1,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px
    style PARSE fill:#0277bd,fill-opacity:0.18,stroke:#4fc3f7,stroke-width:2px
    style CHUNK fill:#006064,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px
    style EMBED fill:#bf360c,fill-opacity:0.18,stroke:#ff8a65,stroke-width:2px
    style STORE fill:#1b5e20,fill-opacity:0.18,stroke:#66bb6a,stroke-width:2px
    style INDEX fill:#f57f17,fill-opacity:0.18,stroke:#ffb74d,stroke-width:2px
    style NOTIFY fill:#c62828,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px
```

---

## 4. Component Interactions

### 4.1 Query Processing Flow (Mermaid Sequence Diagram)

```mermaid
%%{init: {'theme':'dark', 'themeVariables': {'actorTextColor':'#fff', 'noteBkgColor':'#1a237e', 'noteTextColor':'#fff'}}}%%
sequenceDiagram
    title Query Processing Flow
    actor User
    participant UI as Frontend UI<br/>(Mantine)
    participant Gateway as API Gateway<br/>(Nginx)
    participant API as FastAPI<br/>Query Router
    participant Cache as Valkey<br/>(Cache)
    participant Orch as Query<br/>Orchestrator
    participant CM as Concept<br/>Mapper
    participant DR as Document<br/>Retriever
    participant AS as Answer<br/>Synthesizer
    participant QA as Query<br/>Analyzer
    participant Neo4j as Neo4j<br/>(Graph DB)
    participant PG as PostgreSQL<br/>(Metadata)
    participant LLM as LLM Router<br/>(Ollama/OpenAI)

    User->>UI: 1. Submit Query
    UI->>Gateway: 2. POST /api/v1/query
    Gateway->>API: 3. Route + Auth
    API->>Cache: 4. Check Cache
    alt Cache Hit
        Cache-->>API: Return Cached Answer
        API-->>UI: 9. JSON Response
        UI-->>User: Display Answer
    else Cache Miss
        API->>Orch: 5. Distribute Tasks (MCP)
        
        par Parallel Agent Execution
            Orch->>CM: 6a. Extract Concepts
            CM->>Neo4j: Query Concepts
            Neo4j-->>CM: Concept Nodes
            
            Orch->>DR: 6b. Search Documents
            DR->>Neo4j: Vector + Graph Search
            DR->>PG: Metadata Query
            Neo4j-->>DR: Results
            PG-->>DR: Results
            
            Orch->>AS: 6c. Generate Answer
            AS->>LLM: Generate with Context
            LLM-->>AS: Answer + Citations
            
            Orch->>QA: 6d. Analyze Intent
            QA-->>Orch: Intent Analysis
        end
        
        CM-->>Orch: 7. Concept Results
        DR-->>Orch: 7. Document Results
        AS-->>Orch: 7. Generated Answer
        
        Orch->>Orch: 8. Aggregate Results
        Orch->>Cache: Cache Result
        Orch-->>API: Combined Result
        API-->>UI: 9. JSON Response
        UI-->>User: Display Answer
    end
```

### 4.2 Query Processing Flow (3D Architecture View)

```mermaid
%%{init: {'theme': 'base'}}%%
graph TB
    %% Title: 3D Architecture Layers
    subgraph Layer_1["Layer 1: Presentation"]
        class Layer_1 sameWidth;
        User[üë§ User]
        UI[üñ•Ô∏è Frontend UI<br/>React + Mantine]
    end

    subgraph Layer_2["Layer 2: Gateway"]
        class Layer_2 sameWidth;
        Gateway[üö™ API Gateway<br/>Nginx/Traefik<br/>SSL + Load Balancer]
    end

    subgraph Layer_3["Layer 3: Application"]
        class Layer_3 sameWidth;
        API[‚ö° FastAPI<br/>Query Router<br/>Auth + Validation]
        Cache{üíæ Valkey Cache<br/>Exact + Semantic}
    end

    subgraph Layer_4["Layer 4: Orchestration"]
        class Layer_4 sameWidth;
        Orch[üéØ Query Orchestrator<br/>MCP Coordinator]
    end

    subgraph Layer_5["Layer 5: Agent Network"]
        class Layer_5 sameWidth;
        direction LR
        CM[üß† Concept<br/>Mapper<br/>NER + Relations]
        DR[üìö Document<br/>Retriever<br/>Hybrid Search]
        AS[‚úçÔ∏è Answer<br/>Synthesizer<br/>LLM Generation]
        QA[üîç Query<br/>Analyzer<br/>Intent Detection]
    end

    subgraph Layer_6["Layer 6: Data Storage"]
        class Layer_6 sameWidth;
        direction LR
        Neo4j[(üï∏Ô∏è Neo4j<br/>Knowledge Graph<br/>Vectors + Relations)]
        PG[(üóÑÔ∏è PostgreSQL<br/>Structured Data<br/>Metadata)]
    end

    subgraph Layer_7["Layer 7: LLM Providers"]
        class Layer_7 sameWidth;
        direction LR
        Ollama[ü¶ô Ollama<br/>Local Models]
        OpenAI[ü§ñ OpenAI<br/>GPT-4]
        Claude[üé≠ Anthropic<br/>Claude]
        Custom[‚öôÔ∏è Custom<br/>Endpoints]
    end

    User -->|Submit Query| UI
    UI -->|HTTPS| Gateway
    Gateway -->|Route| API
    API -->|Check| Cache
    Cache -.->|Hit| API
    Cache -->|Miss| Orch

    Orch -->|MCP Tasks| CM
    Orch -->|MCP Tasks| DR
    Orch -->|MCP Tasks| AS
    Orch -->|MCP Tasks| QA

    CM <-->|Cypher| Neo4j
    DR <-->|Cypher + SQL| Neo4j
    DR <-->|SQL| PG
    AS -->|Generate| Ollama
    AS -->|Generate| OpenAI
    AS -->|Generate| Claude
    AS -->|Generate| Custom

    CM -->|Results| Orch
    DR -->|Results| Orch
    AS -->|Results| Orch
    QA -->|Results| Orch

    Orch -->|Aggregate| API
    API -->|Cache| Cache
    API -->|Response| UI
    UI -->|Display| User

    style User fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:3px
    style UI fill:#1565c0,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px
    style Gateway fill:#0277bd,fill-opacity:0.18,stroke:#4fc3f7,stroke-width:2px
    style API fill:#01579b,fill-opacity:0.18,stroke:#4dd0e1,stroke-width:2px
    style Cache fill:#006064,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px
    style Orch fill:#004d40,fill-opacity:0.18,stroke:#26a69a,stroke-width:3px
    style CM fill:#1b5e20,fill-opacity:0.18,stroke:#66bb6a,stroke-width:2px
    style DR fill:#33691e,fill-opacity:0.18,stroke:#9ccc65,stroke-width:2px
    style AS fill:#827717,fill-opacity:0.18,stroke:#dce775,stroke-width:2px
    style QA fill:#f57f17,fill-opacity:0.18,stroke:#ffb74d,stroke-width:2px
    style Neo4j fill:#4a148c,fill-opacity:0.18,stroke:#ba68c8,stroke-width:2px
    style PG fill:#6a1b9a,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px
    style Ollama fill:#bf360c,fill-opacity:0.18,stroke:#ff8a65,stroke-width:2px
    style OpenAI fill:#d84315,fill-opacity:0.18,stroke:#ff7043,stroke-width:2px
    style Claude fill:#c62828,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px,color:#fff
    style Custom fill:#880e4f,fill-opacity:0.18,stroke:#f06292,stroke-width:2px,color:#fff

    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

---

## 4.2.1 AI Orchestration Interactions

#### 4.2.1.1 Event Trigger to Workflow Execution

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'actorTextColor':'#fff', 'noteBkgColor':'#1a237e', 'noteTextColor':'#fff'}}}%%
sequenceDiagram
    participant System
    participant Trigger as Event Trigger
    participant Workflow as Workflow Engine
    participant Task as Task Queue
    participant User

    System->>Trigger: Document ingested
    Trigger->>Workflow: Start workflow for document analysis
    Workflow->>Task: Create tasks for concept extraction, document retrieval
    Task->>User: Notify when tasks are complete
```

#### 4.2.1.2 Workflow Example: Ingest & Analyze

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    %% Title: Workflow 1 - Ingest & Analyze
    START["üì• Document Ingested"]
    
    PARSE["1Ô∏è‚É£ Parse Document<br/>Extract text, metadata"]
    
    CHUNK["2Ô∏è‚É£ Chunk Text<br/>Size: 512 tokens<br/>Overlap: 50"]
    
    EMBED["3Ô∏è‚É£ Generate Embeddings<br/>(Ollama)"]
    
    STORE["4Ô∏è‚É£ Store Metadata + Vectors"]
    
    NOTIFY["5Ô∏è‚É£ Notify Completion<br/>User: user@example.com"]
    
    START --> PARSE
    PARSE --> CHUNK
    CHUNK --> EMBED
    EMBED --> STORE
    STORE --> NOTIFY
    
    style START fill:#0d47a1,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px
    style PARSE fill:#0277bd,fill-opacity:0.18,stroke:#4fc3f7,stroke-width:2px
    style CHUNK fill:#006064,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px
    style EMBED fill:#bf360c,fill-opacity:0.18,stroke:#ff8a65,stroke-width:2px
    style STORE fill:#1b5e20,fill-opacity:0.18,stroke:#66bb6a,stroke-width:2px
    style NOTIFY fill:#c62828,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px
```

---

## 5. Data Flow

### 5.1 End-to-End Data Flow with Monitoring

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    %% Title: End-to-End Data Flow with Monitoring
    subgraph "Ingestion Flow"
        direction TB
        UP[üì§ Upload<br/>Document]
        PARSE[üìñ Parse<br/>Content]
        CHUNK[‚úÇÔ∏è Chunk<br/>Text]
        EMBED[üßÆ Generate<br/>Embeddings]
        STORE[(üíæ Store<br/>Data)]
        UP --> PARSE --> CHUNK --> EMBED --> STORE
    end
    
    subgraph "Query Flow"
        direction TB
        QRY[üé§ User<br/>Query]
        CACHE{üíæ Check<br/>Cache}
        SEARCH[üîç Hybrid<br/>Search]
        GEN[ü§ñ Generate<br/>Answer]
        RESP[üìù Return<br/>Response]
        QRY --> CACHE
        CACHE -->|Hit| RESP
        CACHE -->|Miss| SEARCH
        SEARCH --> GEN
        GEN --> RESP
    end
    
    subgraph "Storage Layer"
        direction TB
        PG[(üóÑÔ∏è PostgreSQL<br/>Metadata)]
        NEO[(üï∏Ô∏è Neo4j<br/>Vectors + Graph)]
        VAL[(üíæ Valkey<br/>Cache)]
    end
    
    subgraph "Monitoring Flow"
        direction TB
        METRICS[üìä Metrics<br/>Collection]
        LOGS[üìù Log<br/>Aggregation]
        TRACES[üîç Distributed<br/>Tracing]
        ALERTS[üö® Alert<br/>Manager]
        METRICS --> ALERTS
        LOGS --> ALERTS
        TRACES --> ALERTS
    end
    
    STORE --> PG
    STORE --> NEO
    SEARCH --> NEO
    SEARCH --> PG
    GEN --> VAL
    
    UP -.->|Metrics| METRICS
    PARSE -.->|Metrics| METRICS
    CHUNK -.->|Metrics| METRICS
    EMBED -.->|Metrics| METRICS
    
    QRY -.->|Trace ID| TRACES
    CACHE -.->|Trace| TRACES
    SEARCH -.->|Trace| TRACES
    GEN -.->|Trace| TRACES
    
    PG -.->|Logs| LOGS
    NEO -.->|Logs| LOGS
    VAL -.->|Logs| LOGS
    
    style UP fill:#0d47a1,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px
    style PARSE fill:#0277bd,fill-opacity:0.18,stroke:#4fc3f7,stroke-width:2px
    style CHUNK fill:#006064,fill-opacity:0.18,stroke:#4db6ac,stroke-width:2px
    style EMBED fill:#bf360c,fill-opacity:0.18,stroke:#ff8a65,stroke-width:2px
    style STORE fill:#039be5,fill-opacity:0.18,stroke:#81d4fa,stroke-width:2px
    
    style QRY fill:#1b5e20,fill-opacity:0.18,stroke:#81c784,stroke-width:2px
    style CACHE fill:#2e7d32,fill-opacity:0.18,stroke:#a5d6a7,stroke-width:2px
    style SEARCH fill:#388e3c,fill-opacity:0.18,stroke:#66bb6a,stroke-width:2px
    style GEN fill:#43a047,fill-opacity:0.18,stroke:#9ccc65,stroke-width:2px
    style RESP fill:#2e7d32,fill-opacity:0.18,stroke:#a5d6a7,stroke-width:3px
    
    style PG fill:#6a1b9a,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px
    style NEO fill:#7b1fa2,fill-opacity:0.18,stroke:#ba68c8,stroke-width:2px
    style VAL fill:#8e24aa,fill-opacity:0.18,stroke:#ab47bc,stroke-width:2px
    
    style METRICS fill:#e65100,fill-opacity:0.18,stroke:#ffb74d,stroke-width:2px
    style LOGS fill:#ef6c00,fill-opacity:0.18,stroke:#ffa726,stroke-width:2px
    style TRACES fill:#f57c00,fill-opacity:0.18,stroke:#ff9800,stroke-width:2px
    style ALERTS fill:#ff6f00,fill-opacity:0.18,stroke:#ffab40,stroke-width:2px
```

### 5.2 Query Data Flow (Detailed)

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    %% Title: Query Data Flow - User Query to Response
    Q["üé§ User Query<br/>'How does authentication work in RAGE?'"]
    
    QR["1Ô∏è‚É£ Query Reception<br/>‚Ä¢ Validate input<br/>‚Ä¢ Check rate limits<br/>‚Ä¢ Generate execution ID"]
    
    CACHE{"2Ô∏è‚É£ Cache Lookup (Valkey)<br/>‚Ä¢ Hash query<br/>‚Ä¢ Check recent answers"}
    
    CACHED["‚úÖ Return Cached Answer"]
    
    CE["3Ô∏è‚É£ Concept Extraction<br/>(Concept Mapper Agent)<br/>‚Ä¢ LLM analyzes query<br/>‚Ä¢ Extracts: authentication, RAGE, security<br/>‚Ä¢ Neo4j concept lookup"]
    
    DR["4Ô∏è‚É£ Document Retrieval<br/>Document Retriever Agent<br/><br/>A. Vector Search (Neo4j)<br/>  ‚Ä¢ Generate embedding<br/>  ‚Ä¢ Similarity search ‚Üí 10 docs<br/><br/>B. Keyword Search (PostgreSQL FTS)<br/>  ‚Ä¢ BM25 ranking ‚Üí 10 docs<br/><br/>C. Graph Traversal (Neo4j)<br/>  ‚Ä¢ Start from concepts<br/>  ‚Ä¢ Follow MENTIONS ‚Üí 10 docs<br/><br/>D. Hybrid Fusion (RRF)<br/>  ‚Ä¢ Combine & dedupe ‚Üí Top 10"]
    
    AS["5Ô∏è‚É£ Answer Synthesis<br/>Answer Synthesizer Agent<br/>‚Ä¢ Prepare context<br/>‚Ä¢ Build LLM prompt<br/>‚Ä¢ Route to optimal LLM<br/>‚Ä¢ Generate answer + citations<br/>‚Ä¢ Validate quality<br/>‚Ä¢ Calculate confidence"]
    
    AGG["6Ô∏è‚É£ Result Aggregation<br/>‚Ä¢ Combine agent outputs<br/>‚Ä¢ Format response<br/>‚Ä¢ Generate follow-ups<br/>‚Ä¢ Create citation links"]
    
    LEARN["7Ô∏è‚É£ Learning & Storage<br/>‚Ä¢ Create Query node (Neo4j)<br/>‚Ä¢ Link to Concepts (ASKED_ABOUT)<br/>‚Ä¢ Link to Documents (ANSWERED_BY)<br/>‚Ä¢ Update importance scores<br/>‚Ä¢ Cache in Valkey<br/>‚Ä¢ Log to PostgreSQL"]
    
    RESP["8Ô∏è‚É£ Response to User<br/>{<br/>  answer: 'RAGE uses JWT-based...',<br/>  citations: [...],<br/>  confidence: 0.92,<br/>  follow_up: [...]<br/>}"]
    
    Q --> QR
    QR --> CACHE
    CACHE -->|HIT| CACHED
    CACHE -->|MISS| CE
    CE -->|"Concepts: [auth, security, JWT]"| DR
    DR -->|"Documents: [doc1...doc10]"| AS
    AS -->|"Answer + Citations + Confidence"| AGG
    AGG --> LEARN
    LEARN --> RESP
    
    classDef reception fill:#0d47a1,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px,color:#fff;
    classDef cache fill:#f57f17,fill-opacity:0.18,stroke:#ffd54f,stroke-width:2px,color:#000;
    classDef agent fill:#1b5e20,fill-opacity:0.18,stroke:#81c784,stroke-width:2px,color:#fff;
    classDef result fill:#bf360c,fill-opacity:0.18,stroke:#ff8a65,stroke-width:2px,color:#fff;
    
    class Q,QR reception;
    class CACHE,CACHED cache;
    class CE,DR,AS agent;
    class AGG,LEARN,RESP result;
    
    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

### 5.3 Document Ingestion Data Flow

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}, 'themeVariables': {'labelBackground':'rgba(38, 50, 56, 0.1)'}}}%%
flowchart TD
    %% Title: Document Ingestion Pipeline - PDF to Knowledge Graph
    UPL["üì§ PDF Upload<br/>'RAGE_Architecture.pdf'"]
    
    VAL["1Ô∏è‚É£ Upload & Validation<br/>‚Ä¢ Virus scan<br/>‚Ä¢ File type check<br/>‚Ä¢ Size check (max 50MB)<br/>‚Ä¢ SHA-256 hash"]
    
    DEDUP{"2Ô∏è‚É£ Deduplication Check<br/>(PostgreSQL)<br/>‚Ä¢ Query by hash"}
    
    EXISTS["‚úÖ Return Existing doc_id"]
    
    STORE["3Ô∏è‚É£ Storage (MinIO/S3)<br/>‚Ä¢ Store raw file<br/>‚Ä¢ Key: documents/2025/11/abc123.pdf<br/>‚Ä¢ Generate signed URL (7 days)"]
    
    QUEUE["4Ô∏è‚É£ Queue Task (Valkey)<br/>‚Ä¢ Add to ingestion queue<br/>‚Ä¢ Priority: normal<br/>‚Ä¢ Retry: 3x"]
    
    PROC["5Ô∏è‚É£ Document Processing<br/>‚Ä¢ Download from MinIO<br/>‚Ä¢ Parse PDF (pypdf2)<br/>‚Ä¢ Extract text, metadata, images<br/>‚Ä¢ Result: 25 pages, 15K words"]
    
    CHUNK["6Ô∏è‚É£ Text Chunking<br/>‚Ä¢ Strategy: Sliding window<br/>‚Ä¢ Size: 512 tokens<br/>‚Ä¢ Overlap: 50 tokens<br/>‚Ä¢ Result: 45 chunks"]
    
    EMBED["7Ô∏è‚É£ Embedding Generation<br/>(Ollama)<br/>‚Ä¢ Model: nomic-embed-text<br/>‚Ä¢ Batch: 10<br/>‚Ä¢ Dimension: 768<br/>‚Ä¢ Result: 45 vectors<br/>‚Ä¢ Cache in Valkey"]
    
    DBSTORE["8Ô∏è‚É£ Database Storage<br/><br/>PostgreSQL:<br/>‚Ä¢ INSERT documents<br/>‚Ä¢ INSERT 45 chunks<br/><br/>Neo4j:<br/>‚Ä¢ CREATE Document node<br/>‚Ä¢ Add vector index"]
    
    CONCEPT["9Ô∏è‚É£ Concept Extraction<br/>(Concept Mapper Agent)<br/>‚Ä¢ Concepts: RAG, Architecture, API<br/>‚Ä¢ Entities: Neo4j, FastAPI, Ollama<br/>‚Ä¢ Extract relationships"]
    
    GRAPH["üîü Knowledge Graph<br/>(Neo4j)<br/><br/>‚Ä¢ Create Concept nodes<br/>‚Ä¢ Link Document to Concepts<br/>‚Ä¢ Set relationship properties<br/>‚Ä¢ Add Technology nodes<br/>‚Ä¢ Build USES_TECHNOLOGY links"]
    
    POST["1Ô∏è‚É£1Ô∏è‚É£ Post-Processing<br/>‚Ä¢ Update statistics<br/>‚Ä¢ Recalculate PageRank<br/>‚Ä¢ Update indexes<br/>‚Ä¢ Notify user (WebSocket)<br/>‚Ä¢ Clear caches"]
    
    DONE["1Ô∏è‚É£2Ô∏è‚É£ Completion<br/><br/>status: success<br/>document_id: abc123<br/>chunks: 45<br/>concepts: 12<br/>entities: 8<br/>processing_time: 12.5s"]
    
    UPL --> VAL
    VAL -->|"Hash: abc123..."| DEDUP
    DEDUP -->|Exists| EXISTS
    DEDUP -->|New| STORE
    STORE --> QUEUE
    QUEUE --> PROC
    PROC -->|"Extracted text"| CHUNK
    CHUNK -->|"45 chunks"| EMBED
    EMBED -->|"45 vectors"| DBSTORE
    DBSTORE --> CONCEPT
    CONCEPT --> GRAPH
    GRAPH --> POST
    POST --> DONE
    
    %% Class Definitions (added for Mermaid rendering correctness)
    classDef upload fill:#0d47a1,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px,color:#fff;
    classDef process fill:#0277bd,fill-opacity:0.18,stroke:#4fc3f7,stroke-width:2px,color:#fff;
    classDef storage fill:#6a1b9a,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px,color:#fff;
    classDef graphNode fill:#7b1fa2,fill-opacity:0.18,stroke:#ba68c8,stroke-width:2px,color:#fff;
    classDef complete fill:#2e7d32,fill-opacity:0.18,stroke:#a5d6a7,stroke-width:2px,color:#fff;
    
    %% Class Assignments
    class UPL,VAL upload;
    class DEDUP,EXISTS upload;
    class STORE,QUEUE,PROC,CHUNK,EMBED process;
    class DBSTORE storage;
    class CONCEPT,GRAPH graphNode;
    class POST,DONE complete;
    
    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

---

## 6. Scalability & Performance

### 6.1 Horizontal Scaling

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}}}%%
flowchart TD
    %% Title: Horizontal Scaling Architecture
    LB["‚öñÔ∏è Load Balancer (Nginx)<br/>‚Ä¢ Round-robin<br/>‚Ä¢ Health checks<br/>‚Ä¢ SSL termination"]
    
    API1["‚ö° API Server 1<br/>(Podman)"]
    API2["‚ö° API Server 2<br/>(Podman)"]
    API3["‚ö° API Server N<br/>(Podman)"]
    
    SHARED["üíæ Shared Services<br/>‚Ä¢ PostgreSQL<br/>‚Ä¢ Neo4j<br/>‚Ä¢ Valkey"]
    
    LB --> API1
    LB --> API2
    LB --> API3
    
    API1 --> SHARED
    API2 --> SHARED
    API3 --> SHARED
    
    classDef lb fill:#0277bd,fill-opacity:0.18,stroke:#4fc3f7,stroke-width:3px,color:#fff;
    classDef api fill:#0d47a1,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px,color:#fff;
    classDef shared fill:#6a1b9a,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px,color:#fff;
    
    class LB lb;
    class API1,API2,API3 api;
    class SHARED shared;
    
    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

**Scaling Strategy**:
- **API Servers**: Stateless, scale horizontally behind load balancer
- **Agents**: Run as separate processes, scale independently
- **Databases**: 
  - PostgreSQL: Read replicas for queries
  - Neo4j: Clustering for high availability
  - Valkey: Sentinel for automatic failover

### 6.2 Performance Optimizations

| Component | Optimization | Impact |
|-----------|-------------|--------|
| **Vector Search** | HNSW index in Neo4j | 10x faster queries |
| **Keyword Search** | GIN index on tsvector | 5x faster full-text |
| **Cache** | Valkey with LRU eviction | 50% fewer DB queries |
| **Embeddings** | Batch processing | 3x faster ingestion |
| **LLM** | Response caching | 80% cost reduction |
| **API** | Connection pooling | Handle 10x requests |
| **Frontend** | Code splitting | 50% faster load |

### 6.3 Resource Requirements

**Minimum (Development)**:
```yaml
CPU: 8 cores
RAM: 16 GB
Disk: 100 GB SSD
Network: 100 Mbps

Containers:
  - PostgreSQL: 2 GB RAM
  - Workflow Service: 512 MB RAM
  - Profile Service: 512 MB RAM
  - Temporal Service: 512 MB RAM
  - Neo4j: 4 GB RAM
  - Valkey: 1 GB RAM
  - API: 2 GB RAM
  - Agents: 2 GB RAM each
  - Ollama: 4 GB RAM (8 GB with GPU)
```

**Production (Single Server)**:
```yaml
CPU: 16 cores
RAM: 64 GB
Disk: 1 TB NVMe SSD
Network: 1 Gbps
GPU: Optional (8GB+ VRAM for local LLMs)

Containers:
  - PostgreSQL: 8 GB RAM
  - Neo4j: 16 GB RAM
  - Valkey: 4 GB RAM
  - API (x3): 4 GB RAM each
  - Agents: 4 GB RAM each
  - Ollama: 16 GB RAM (with GPU)
```

**High Availability (Multi-Server)**:
```yaml
3x Application Servers (each):
  - CPU: 16 cores
  - RAM: 32 GB
  - Disk: 500 GB SSD

1x Database Server:
  - CPU: 32 cores
  - RAM: 128 GB
  - Disk: 2 TB NVMe SSD RAID

1x Cache Server:
  - CPU: 8 cores
  - RAM: 64 GB
  - Disk: 500 GB SSD
```

---

## 7. Security Architecture

### 7.1 Security Layers

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}}}%%
flowchart TD
    %% Title: Security Architecture - 8 Defense Layers
    TITLE["üîí Security Architecture"]
    
    L1["1Ô∏è‚É£ Network Security<br/>‚Ä¢ Firewall (ports 80, 443 only)<br/>‚Ä¢ DDoS protection<br/>‚Ä¢ Rate limiting (100 req/min)<br/>‚Ä¢ GeoIP blocking"]
    
    L2["2Ô∏è‚É£ Transport Security<br/>‚Ä¢ TLS 1.3 mandatory<br/>‚Ä¢ Let's Encrypt certs<br/>‚Ä¢ HSTS headers<br/>‚Ä¢ Perfect forward secrecy"]
    
    L3["3Ô∏è‚É£ Authentication<br/>‚Ä¢ JWT tokens (access + refresh)<br/>‚Ä¢ Argon2 password hashing<br/>‚Ä¢ MFA support (TOTP)<br/>‚Ä¢ Session management<br/>‚Ä¢ OAuth2/OIDC (future)"]
    
    L4["4Ô∏è‚É£ Authorization<br/>‚Ä¢ RBAC (Role-Based Access)<br/>‚Ä¢ Document-level ACL<br/>‚Ä¢ Team permissions<br/>‚Ä¢ Fine-grained controls"]
    
    L5["5Ô∏è‚É£ Data Security<br/>‚Ä¢ AES-256 encryption at rest<br/>‚Ä¢ Database encryption<br/>‚Ä¢ Secure key management<br/>‚Ä¢ PII masking"]
    
    L6["6Ô∏è‚É£ Container Security<br/>‚Ä¢ Non-root containers (Podman)<br/>‚Ä¢ Read-only filesystems<br/>‚Ä¢ Resource limits<br/>‚Ä¢ Security scanning<br/>‚Ä¢ Minimal base images"]
    
    L7["7Ô∏è‚É£ Application Security<br/>‚Ä¢ Input validation (Pydantic)<br/>‚Ä¢ ORM (SQL injection prevention)<br/>‚Ä¢ XSS protection<br/>‚Ä¢ CSRF tokens<br/>‚Ä¢ Security headers"]
    
    L8["8Ô∏è‚É£ Audit & Compliance<br/>‚Ä¢ Complete audit trail<br/>‚Ä¢ 90-day log retention<br/>‚Ä¢ Compliance reporting<br/>‚Ä¢ Anomaly detection"]
    
    TITLE --> L1
    L1 --> L2
    L2 --> L3
    L3 --> L4
    L4 --> L5
    L5 --> L6
    L6 --> L7
    L7 --> L8
    
    classDef title fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:3px,color:#fff;
    classDef layer fill:#4a148c,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px,color:#fff;
    
    class TITLE title;
    class L1,L2,L3,L4,L5,L6,L7,L8 layer;
    
    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

### 7.2 Authentication Flow

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}}}%%
flowchart TD
    %% Title: User Authentication Flow - Login to JWT Token
    REQ["üì® POST /login<br/>{<br/>  email,<br/>  password<br/>}"]
    
    VAL["‚úÖ Validate Input<br/>(Pydantic)"]
    
    QRY["üîç Query User<br/>(PostgreSQL)"]
    
    PWD["üîê Verify Password<br/>(Argon2 hash)"]
    
    JWT["üé´ Generate JWT Tokens<br/>‚Ä¢ Access token (1h)<br/>‚Ä¢ Refresh token (7d)"]
    
    SESS["üíæ Store Session<br/>(Valkey)<br/>TTL: 7 days"]
    
    RESP["‚úÖ Return Tokens<br/>{<br/>  access_token,<br/>  refresh_token,<br/>  expires_in: 3600<br/>}"]
    
    FAIL["‚ùå Authentication Failed\n401 Unauthorized"]
    
    REQ --> VAL
    VAL --> QRY
    QRY --> PWD
    PWD -->|Valid| JWT
    PWD -->|Invalid| FAIL
    JWT --> SESS
    SESS --> RESP
    
    classDef request fill:#0d47a1,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px,color:#fff;
    classDef process fill:#4a148c,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px,color:#fff;
    classDef success fill:#1b5e20,fill-opacity:0.18,stroke:#81c784,stroke-width:2px,color:#fff;
    classDef error fill:#b71c1c,fill-opacity:0.18,stroke:#ef5350,stroke-width:2px,color:#fff;
    
    class REQ request;
    class VAL,QRY,PWD,JWT,SESS process;
    class RESP success;
    class FAIL error;
    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

### 7.3 Authorization (ACL)

**Document Access Control**:

```cypher
// Check if user can access document
MATCH (u:User {id: $user_id})
MATCH (d:Document {id: $doc_id})

// Direct user permission
OPTIONAL MATCH (u)-[r1:CAN_ACCESS]->(d)

// Team permission
OPTIONAL MATCH (u)-[:MEMBER_OF]->(t:Team)-[r2:CAN_ACCESS]->(d)

// Organization permission
OPTIONAL MATCH (u)-[:BELONGS_TO]->(org:Organization)-[r3:CAN_ACCESS]->(d)

// Public document
OPTIONAL MATCH (d) WHERE d.is_public = true

RETURN COALESCE(
  r1.permission,
  r2.permission,
  r3.permission,
  CASE WHEN d.is_public THEN 'read' ELSE null END
) as permission
```

---

## 8. Monitoring Architecture

### 8.1 Comprehensive Monitoring Stack with Netdata

```mermaid
%%{init: {'theme': 'base'}}%%
flowchart TD
    %% Title: Comprehensive Monitoring Stack

    subgraph CONTAINERS["üê≥ All RAGE Containers"]
        direction TB
        C1["‚ö° API Servers (3x)<br/>‚óè Netdata Agent"]
        C2["üß† Agent Services (4x)<br/>‚óè Netdata Agent"]
        C3["üíæ Databases (3x)<br/>PostgreSQL ‚Ä¢ Neo4j ‚Ä¢ Valkey<br/>‚óè Netdata Agent"]
        C4["ü¶ô LLM Services<br/>Ollama ‚Ä¢ Router<br/>‚óè Netdata Agent"]
    end

    CONTAINERS -->|Stream Metrics| COLLECT
    CONTAINERS -.->|Send Traces| TRACE
    CONTAINERS -.->|Send Logs| LOGS

    subgraph COLLECT["üìä Metrics Collection"]
        direction TB
        NET["Netdata Parent :19999<br/>Aggregates all agents<br/>Real-time dashboards<br/>24h history"]
        PROM["Prometheus :9090<br/>Long-term storage: 90d<br/>PromQL queries<br/>Alert rules"]
        NET -->|Export| PROM
    end

    subgraph TRACE["üîç Distributed Tracing"]
        JAEGER["Jaeger :16686<br/>Request flow visualization<br/>Latency analysis<br/>Dependency mapping"]
    end

    subgraph LOGS["üìù Log Aggregation"]
        LOKI["Loki :3100<br/>Log aggregation<br/>LogQL queries<br/>30-day retention"]
    end

    COLLECT -->|Query| VIZ
    TRACE -->|Query| VIZ
    LOGS -->|Query| VIZ

    subgraph VIZ["üìà Visualization"]
        GRAF["Grafana :3000<br/><br/>Dashboards:<br/>System ‚Ä¢ API ‚Ä¢ Database<br/>Agents ‚Ä¢ LLM Costs<br/>Cache Hits ‚Ä¢ Latency"]
    end
    
    PROM -->|Fire Alerts| ALERT
    NET -->|Fire Alerts| ALERT

    subgraph ALERT["üö® Alerting"]
        direction TB
        AM["Alert Manager<br/>Route ‚Ä¢ Dedupe ‚Ä¢ Silence"]
        AM -->|Notify| N1["üìß Email"]
        AM -->|Notify| N2["üí¨ Slack"]
        AM -->|Notify| N3["üìü PagerDuty"]
    end
```

### 8.2 Netdata Per-Container Metrics

```mermaid
%%{init: {'theme':'dark', 'flowchart': {'nodeSpacing': 30, 'rankSpacing': 40, 'curve': 'basis'}}}%%
graph LR
    %% Title: Netdata Per-Container Metrics
    subgraph "rage-api-1 Container"
        direction TB
        API_PROC[‚öôÔ∏è Process Metrics<br/>‚Ä¢ CPU usage<br/>‚Ä¢ Memory RSS<br/>‚Ä¢ Thread count<br/>‚Ä¢ File descriptors]
        
        API_APP[üìä Application Metrics<br/>‚Ä¢ Request rate: req/sec<br/>‚Ä¢ Response time: p50/p95/p99<br/>‚Ä¢ Error rate: 4xx/5xx<br/>‚Ä¢ Active connections<br/>‚Ä¢ WebSocket sessions]
        
        API_SYS[üíª System Metrics<br/>‚Ä¢ CPU: user/system/idle<br/>‚Ä¢ Memory: used/cached/buffers<br/>‚Ä¢ Disk I/O: read/write IOPS<br/>‚Ä¢ Network: packets/bandwidth]
        
        API_CUSTOM[üéØ Custom Business Metrics<br/>‚Ä¢ Queries/minute<br/>‚Ä¢ Cache hit rate<br/>‚Ä¢ LLM token usage<br/>‚Ä¢ Average confidence score<br/>‚Ä¢ Agent task queue length]
    end
    
    API_PROC --> NETDATA_AGENT[üìä Netdata Agent<br/>Inside Container]
    API_APP --> NETDATA_AGENT
    API_SYS --> NETDATA_AGENT
    API_CUSTOM --> NETDATA_AGENT
    
    NETDATA_AGENT -->|Stream to Parent| NETDATA_PARENT[üìä Netdata Parent<br/>Central Instance]
    
    style API_PROC fill:#0d47a1,fill-opacity:0.18,stroke:#64b5f6,stroke-width:2px,color:#fff
    style API_APP fill:#1b5e20,fill-opacity:0.18,stroke:#81c784,stroke-width:2px,color:#fff
    style API_SYS fill:#6a1b9a,fill-opacity:0.18,stroke:#ce93d8,stroke-width:2px,color:#fff
    style API_CUSTOM fill:#bf360c,fill-opacity:0.18,stroke:#ff8a65,stroke-width:2px,color:#fff
    style NETDATA_AGENT fill:#1a237e,fill-opacity:0.18,stroke:#7986cb,stroke-width:3px,color:#fff
    style NETDATA_PARENT fill:#4a148c,fill-opacity:0.18,stroke:#ce93d8,stroke-width:3px,color:#fff
    linkStyle default stroke:#64b5f6,stroke-width:2px;
```

### 8.2 Key Metrics Tracked

**System Metrics** (per container):
- CPU usage (user, system, idle)
- Memory usage (used, cached, buffers)
- Disk I/O (read/write IOPS, throughput)
- Network (packets, bandwidth, errors)
- Container health (restarts, status)

**Application Metrics**:
```yaml
API:
  - Request rate (req/sec)
  - Response time (p50, p95, p99)
  - Error rate (4xx, 5xx)
  - Active connections
  - WebSocket connections

Agents:
  - Task queue length
  - Task processing time
  - Success/failure rate
  - Agent utilization

Database:
  - Query latency
  - Connection pool usage
  - Cache hit ratio
  - Slow queries

LLM:
  - Token usage (input/output)
  - Cost per query
  - Provider latency
  - Fallback rate
```

### 8.3 Alerting Rules

```yaml
# prometheus/alerts.yml

groups:
  - name: RAGE_Critical
    interval: 30s
    rules:
      - alert: APIDown
        expr: up{job="rage-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "API server is down"
          
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate: {{ $value }}"
          
      - alert: DatabaseConnectionPoolExhausted
        expr: pg_stat_activity_count >= pg_settings_max_connections * 0.9
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Database connection pool near limit"
          
      - alert: HighMemoryUsage
        expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Container {{ $labels.container }} high memory"
          
      - alert: LLMCostThreshold
        expr: sum(increase(llm_cost_usd[1d])) > 100
        labels:
          severity: warning
        annotations:
          summary: "Daily LLM cost exceeded $100"
```

---

## Summary

This architecture document provides a comprehensive view of the RAGE system:

- **Modular Design**: Clear separation of concerns across layers
- **Scalable**: Horizontal scaling of stateless components
- **Observable**: Netdata agents in every container + Prometheus + Grafana
- **Secure**: Multiple security layers from network to application
- **Flexible**: Multi-LLM support with intelligent routing
- **Resilient**: Fallback mechanisms and error recovery
- **Podman-First**: Rootless containers with Docker fallback
- **Production-Ready**: Monitoring, logging, tracing, and alerting

**Next Documents to Review**:
1. [API Specification](API.md) - Detailed API endpoints
2. [Agent System](AGENTS.md) - Neural agent specifications
3. [Database Schema](DATABASE.md) - Complete data models
4. [Deployment Guide](DEPLOYMENT.md) - Production deployment


