openapi: 3.1.0
info:
  title: RAGE Workflow Service API
  description: |
    Scheduled workflow orchestration and automation service for RAGE.
    
    Enables users to configure autonomous agent workflows that execute on schedules
    or events. Supports multi-step workflows with agent coordination, user context
    injection, and conditional execution.
    
    **Key Features:**
    - Cron-based scheduling with user timezone support
    - Event-triggered workflows (e.g., "after 3 meals logged")
    - Multi-step workflows with variable passing
    - Agent orchestration across specialized agents
    - User profile context injection
    - Execution history and audit trails
    
  version: 1.0.0
  contact:
    name: RAGE Team
    url: https://github.com/veics/rage
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:8006
    description: Local development
  - url: http://workflow-service:8006
    description: Docker/Podman internal
  - url: https://api.rage.example.com/workflow
    description: Production

tags:
  - name: workflows
    description: Workflow definition management
  - name: executions
    description: Workflow execution and monitoring
  - name: templates
    description: Workflow templates and examples
  - name: scheduling
    description: Schedule management

paths:
  /api/v1/workflows:
    get:
      summary: List workflows
      description: Retrieve all workflows for the authenticated user
      operationId: listWorkflows
      tags: [workflows]
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [enabled, disabled, all]
            default: all
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Workflows retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  workflows:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkflowSummary'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'
    
    post:
      summary: Create workflow
      description: Create a new workflow definition
      operationId: createWorkflow
      tags: [workflows]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowCreate'
      responses:
        '201':
          description: Workflow created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/workflows/{workflow_id}:
    get:
      summary: Get workflow
      description: Retrieve a specific workflow by ID
      operationId: getWorkflow
      tags: [workflows]
      security:
        - bearerAuth: []
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'
    
    put:
      summary: Update workflow
      description: Update an existing workflow definition
      operationId: updateWorkflow
      tags: [workflows]
      security:
        - bearerAuth: []
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowUpdate'
      responses:
        '200':
          description: Workflow updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'
    
    delete:
      summary: Delete workflow
      description: Delete a workflow (stops all scheduled executions)
      operationId: deleteWorkflow
      tags: [workflows]
      security:
        - bearerAuth: []
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Workflow deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/workflows/{workflow_id}/execute:
    post:
      summary: Execute workflow manually
      description: Trigger immediate execution of a workflow (bypasses schedule)
      operationId: executeWorkflow
      tags: [executions]
      security:
        - bearerAuth: []
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                context:
                  type: object
                  description: Additional context variables for this execution
                  additionalProperties: true
      responses:
        '202':
          description: Workflow execution started
          content:
            application/json:
              schema:
                type: object
                properties:
                  execution_id:
                    type: string
                    format: uuid
                  workflow_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [queued, running]
                  started_at:
                    type: string
                    format: date-time
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/workflows/{workflow_id}/enable:
    post:
      summary: Enable workflow
      description: Enable workflow scheduling (starts accepting triggers)
      operationId: enableWorkflow
      tags: [workflows]
      security:
        - bearerAuth: []
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow enabled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/workflows/{workflow_id}/disable:
    post:
      summary: Disable workflow
      description: Disable workflow scheduling (stops accepting new triggers)
      operationId: disableWorkflow
      tags: [workflows]
      security:
        - bearerAuth: []
      parameters:
        - name: workflow_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Workflow disabled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/executions:
    get:
      summary: List executions
      description: Retrieve workflow execution history
      operationId: listExecutions
      tags: [executions]
      security:
        - bearerAuth: []
      parameters:
        - name: workflow_id
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by workflow ID
        - name: status
          in: query
          schema:
            type: string
            enum: [queued, running, completed, failed, cancelled]
        - name: start_time
          in: query
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Executions retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  executions:
                    type: array
                    items:
                      $ref: '#/components/schemas/ExecutionSummary'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/executions/{execution_id}:
    get:
      summary: Get execution details
      description: Retrieve detailed information about a specific execution
      operationId: getExecution
      tags: [executions]
      security:
        - bearerAuth: []
      parameters:
        - name: execution_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Execution retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Execution'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/executions/{execution_id}/cancel:
    post:
      summary: Cancel execution
      description: Cancel a running or queued workflow execution
      operationId: cancelExecution
      tags: [executions]
      security:
        - bearerAuth: []
      parameters:
        - name: execution_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Execution cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Execution'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Execution cannot be cancelled (already completed/failed)
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/templates:
    get:
      summary: List workflow templates
      description: Retrieve available workflow templates
      operationId: listTemplates
      tags: [templates]
      security:
        - bearerAuth: []
      parameters:
        - name: category
          in: query
          schema:
            type: string
            enum: [productivity, health, automation, analytics, notification]
      responses:
        '200':
          description: Templates retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  templates:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkflowTemplate'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/templates/{template_id}/instantiate:
    post:
      summary: Create workflow from template
      description: Instantiate a workflow from a predefined template
      operationId: instantiateTemplate
      tags: [templates]
      security:
        - bearerAuth: []
      parameters:
        - name: template_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Custom name for the workflow
                parameters:
                  type: object
                  description: Template-specific parameters
                  additionalProperties: true
      responses:
        '201':
          description: Workflow created from template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from ACL service

  schemas:
    Workflow:
      type: object
      required:
        - id
        - user_id
        - name
        - triggers
        - steps
        - enabled
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          description: Owner user ID
        name:
          type: string
          minLength: 1
          maxLength: 255
        description:
          type: string
          maxLength: 1000
        triggers:
          type: array
          items:
            $ref: '#/components/schemas/Trigger'
          minItems: 1
        steps:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowStep'
          minItems: 1
        enabled:
          type: boolean
          default: true
        timeout_seconds:
          type: integer
          minimum: 60
          maximum: 3600
          default: 300
        max_retries:
          type: integer
          minimum: 0
          maximum: 5
          default: 0
        metadata:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        last_executed_at:
          type: string
          format: date-time
          nullable: true
        execution_count:
          type: integer
          default: 0

    WorkflowSummary:
      type: object
      required:
        - id
        - name
        - enabled
        - last_executed_at
        - execution_count
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        enabled:
          type: boolean
        trigger_count:
          type: integer
        step_count:
          type: integer
        last_executed_at:
          type: string
          format: date-time
          nullable: true
        last_status:
          type: string
          enum: [completed, failed, running]
          nullable: true
        execution_count:
          type: integer
        created_at:
          type: string
          format: date-time

    WorkflowCreate:
      type: object
      required:
        - name
        - triggers
        - steps
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        description:
          type: string
          maxLength: 1000
        triggers:
          type: array
          items:
            $ref: '#/components/schemas/Trigger'
          minItems: 1
        steps:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowStep'
          minItems: 1
        enabled:
          type: boolean
          default: true
        timeout_seconds:
          type: integer
          minimum: 60
          maximum: 3600
          default: 300
        metadata:
          type: object
          additionalProperties: true

    WorkflowUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        description:
          type: string
          maxLength: 1000
        triggers:
          type: array
          items:
            $ref: '#/components/schemas/Trigger'
          minItems: 1
        steps:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowStep'
          minItems: 1
        timeout_seconds:
          type: integer
          minimum: 60
          maximum: 3600
        metadata:
          type: object
          additionalProperties: true

    Trigger:
      type: object
      required:
        - type
      discriminator:
        propertyName: type
        mapping:
          cron: '#/components/schemas/CronTrigger'
          event: '#/components/schemas/EventTrigger'
      oneOf:
        - $ref: '#/components/schemas/CronTrigger'
        - $ref: '#/components/schemas/EventTrigger'

    CronTrigger:
      type: object
      required:
        - type
        - schedule
      properties:
        type:
          type: string
          enum: [cron]
        schedule:
          type: string
          description: Cron expression (e.g., "0 20 * * *" for 8pm daily)
          pattern: '^(\*|([0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9])|\*\/([0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9])) (\*|([0-9]|1[0-9]|2[0-3])|\*\/([0-9]|1[0-9]|2[0-3])) (\*|([1-9]|1[0-9]|2[0-9]|3[0-1])|\*\/([1-9]|1[0-9]|2[0-9]|3[0-1])) (\*|([1-9]|1[0-2])|\*\/([1-9]|1[0-2])) (\*|([0-6])|\*\/([0-6]))$'
        timezone:
          type: string
          description: IANA timezone (e.g., "America/New_York"). Defaults to user profile timezone.
          default: "UTC"
        enabled:
          type: boolean
          default: true

    EventTrigger:
      type: object
      required:
        - type
        - event_name
      properties:
        type:
          type: string
          enum: [event]
        event_name:
          type: string
          description: Event to listen for (e.g., "meal_logged", "document_ingested")
        condition:
          type: string
          description: Optional condition expression (e.g., "meal_count >= 3")
        enabled:
          type: boolean
          default: true

    WorkflowStep:
      type: object
      required:
        - id
        - agent
        - action
      properties:
        id:
          type: string
          description: Unique step identifier within workflow
        agent:
          type: string
          description: Agent to execute (e.g., "data_collector", "nutrition_advisor")
        action:
          type: string
          description: Action to perform (e.g., "query_rag", "analyze", "notify")
        input:
          type: object
          description: Input data with template variable support ({{variable_name}})
          additionalProperties: true
        output_variable:
          type: string
          description: Variable name to store step output
        retry_on_failure:
          type: boolean
          default: false
        timeout_seconds:
          type: integer
          minimum: 10
          maximum: 600
          default: 60
        condition:
          type: string
          description: Optional condition to execute step (e.g., "{{previous_step.success}}")

    Execution:
      type: object
      required:
        - id
        - workflow_id
        - user_id
        - status
        - started_at
      properties:
        id:
          type: string
          format: uuid
        workflow_id:
          type: string
          format: uuid
        user_id:
          type: string
        trigger_type:
          type: string
          enum: [manual, cron, event]
        trigger_details:
          type: object
          additionalProperties: true
        status:
          type: string
          enum: [queued, running, completed, failed, cancelled]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        duration_ms:
          type: integer
          nullable: true
        step_results:
          type: array
          items:
            $ref: '#/components/schemas/StepResult'
        error:
          type: string
          nullable: true
        context:
          type: object
          description: Initial context variables
          additionalProperties: true
        output:
          type: object
          description: Final workflow output
          additionalProperties: true

    ExecutionSummary:
      type: object
      required:
        - id
        - workflow_id
        - status
        - started_at
      properties:
        id:
          type: string
          format: uuid
        workflow_id:
          type: string
          format: uuid
        workflow_name:
          type: string
        status:
          type: string
          enum: [queued, running, completed, failed, cancelled]
        trigger_type:
          type: string
          enum: [manual, cron, event]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        duration_ms:
          type: integer
          nullable: true
        step_count:
          type: integer
        steps_completed:
          type: integer
        error:
          type: string
          nullable: true

    StepResult:
      type: object
      required:
        - step_id
        - status
        - started_at
      properties:
        step_id:
          type: string
        agent:
          type: string
        action:
          type: string
        status:
          type: string
          enum: [running, completed, failed, skipped]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        duration_ms:
          type: integer
          nullable: true
        input:
          type: object
          additionalProperties: true
        output:
          type: object
          additionalProperties: true
        error:
          type: string
          nullable: true
        retry_count:
          type: integer
          default: 0

    WorkflowTemplate:
      type: object
      required:
        - id
        - name
        - category
        - definition
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        category:
          type: string
          enum: [productivity, health, automation, analytics, notification]
        tags:
          type: array
          items:
            type: string
        definition:
          $ref: '#/components/schemas/WorkflowCreate'
        parameters:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
                enum: [string, number, boolean, object]
              description:
                type: string
              required:
                type: boolean
              default:
                description: Default value
        examples:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              parameters:
                type: object
                additionalProperties: true

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
        request_id:
          type: string
          format: uuid

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
